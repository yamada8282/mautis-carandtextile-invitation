<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INDUSTRIAL RUN - Advanced</title>
    <!-- Google Fonts: Noto Sans JP and Barlow (as alternative to DIN) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #fff;
            /* èƒŒæ™¯ã‚’ç™½ã« */
            font-family: 'DIN 2014', 'Barlow', 'Noto Sans JP', sans-serif;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100vh;
        }

        /* CRTãƒ¢ãƒ‹ã‚¿ãƒ¼é¢¨ã®èµ°æŸ»ç·šï¼ˆå°‘ã—è–„ãã—ã¾ã—ãŸï¼‰ */
        #scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.04) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            background-size: 100% 4px, 6px 100%;
            pointer-events: none;
            z-index: 10;
        }

        #ui-layer {
            position: absolute;
            /* å­—å¹•ã®ä½ç½® */
            top: 30%;
            width: 100%;
            text-align: center;
            color: #000;
            font-size: 13px;
            pointer-events: none;
            z-index: 20;
            font-family: 'DIN 2014', 'Barlow', 'Noto Sans JP', sans-serif;
            line-height: 1.5;
        }

        /* é€Ÿåº¦è¨ˆ */
        #speedometer {
            position: fixed;
            top: 20px;
            /* right: 20px; */
            /* ä¸­å¤®é…ç½®ã«å¤‰æ›´ */
            left: 50%;
            transform: translateX(-50%);
            color: #000;
            font-family: 'DIN 2014', 'Barlow', 'Noto Sans JP', sans-serif;
            font-size: 18px;
            pointer-events: none;
            z-index: 30;
            padding: 10px 15px;
            border-bottom: 2px solid #000;
            text-align: center;
        }

        #speedometer .label {
            font-size: 10px;
            color: #000;
            margin-bottom: 5px;
        }

        #speedometer .speed {
            font-size: 24px;
            line-height: 1;
        }

        #speedometer .unit {
            font-size: 11px;
            color: #000;
            margin-left: 5px;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            min-height: 100vh;
            min-height: 100dvh;
            background: #fff;
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #000;
            font-family: 'DIN 2014', 'Barlow', 'Noto Sans JP', sans-serif;
            letter-spacing: 0.1em;
            overflow: hidden;
            padding: 20px 0;
        }

        #start-screen.hidden {
            display: none;
        }

        #start-screen .event-title {
            font-size: 22px;
            margin-bottom: 5px;
            text-align: center;
            color: #000;
            text-transform: uppercase;
        }

        #start-screen .event-date {
            font-size: 12px;
            margin-bottom: 60px;
            color: #000;
            border-top: 1px solid #000;
            padding-top: 5px;
            display: inline-block;
        }

        #start-screen .init-button {
            padding: 15px 50px;
            background: #fff;
            border: 1px solid #000;
            color: #000;
            border: 1px solid #000;
            color: #000;
            font-family: 'DIN 2014', 'Barlow', 'Noto Sans JP', sans-serif;
            font-size: 14px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            position: relative;
            overflow: hidden;
            transition: all 0.1s;
        }

        #start-screen .init-button:hover {
            background: #000;
            color: #fff;
        }

        #start-screen .init-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: skewX(-20deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% {
                left: -100%;
            }

            20% {
                left: 200%;
            }

            100% {
                left: 200%;
            }
        }

        #start-screen .glitch-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            opacity: 0;
            pointer-events: none;
            z-index: 10;
        }

        #start-screen .glitch-overlay.active {
            animation: glitch 0.5s;
        }

        @keyframes glitch {
            0% {
                transform: translate(0);
            }

            20% {
                transform: translate(-5px, 5px);
            }

            40% {
                transform: translate(-5px, -5px);
            }

            60% {
                transform: translate(5px, 5px);
            }

            80% {
                transform: translate(5px, -5px);
            }

            100% {
                transform: translate(0);
            }
        }

        /* ãƒ›ãƒ¯ã‚¤ãƒˆã‚¢ã‚¦ãƒˆãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #whiteout-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #fff;
            opacity: 0;
            pointer-events: none;
            z-index: 5000;
            transition: none;
            /* JSåˆ¶å¾¡ã®ãŸã‚transitionå‰Šé™¤ */
        }

        /* çµæœç”»é¢ */
        #result-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            min-height: 100vh;
            min-height: 100dvh;
            background: #fff;
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            color: #000;
            font-family: 'DIN 2014', 'Barlow', 'Noto Sans JP', sans-serif;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 60px 20px;
            box-sizing: border-box;
        }

        #result-screen.active {
            display: flex;
        }

        #result-screen .loading {
            font-size: 24px;
            margin-bottom: 20px;
        }

        #result-screen .header {
            font-size: 20px;
            margin-bottom: 30px;
            color: #000;
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            width: 90%;
        }

        #result-screen .loading {
            font-size: 24px;
            margin-bottom: 20px;
        }

        #result-screen .material-image {
            max-width: 90%;
            max-height: 50vh;
            border: 1px solid #000;
            margin: 20px 0;
            background: #fff;
        }

        #result-screen .material-id {
            font-size: 18px;
            margin: 15px 0;
            text-align: center;
            color: #000;
        }

        #result-screen .spec-info {
            font-size: 14px;
            margin: 10px 0;
            text-align: center;
            color: #666;
        }

        #result-screen .share-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        #result-screen .share-btn {
            padding: 10px 20px;
            background: #fff;
            border: 1px solid #000;
            color: #000;
            cursor: pointer;
            font-family: 'DIN 2014', 'Barlow', 'Noto Sans JP', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
        }

        #result-screen .share-btn:hover {
            background: #000;
            color: #fff;
        }

        #result-screen .reserve-btn {
            padding: 15px 30px;
            background: #000;
            border: none;
            color: #fff;
            cursor: pointer;
            font-family: 'DIN 2014', 'Barlow', 'Noto Sans JP', sans-serif;
            font-size: 16px;
            margin-top: 20px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.3s;
        }

        #result-screen .reserve-btn:hover {
            background: #333;
            color: #fff;
        }

        #result-screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            z-index: 100;
            overflow-y: auto;
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
            padding-bottom: 50px;
        }

        #result-screen.active {
            display: flex;
        }

        /* çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        #analysis-report {
            width: 85%;
            max-width: 500px;
            margin: 20px auto;
            text-align: left;
            font-family: 'Noto Sans JP', sans-serif;
            color: #333;
            line-height: 1.8;
            font-size: 13px;
        }

        .report-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .report-title {
            font-family: 'DIN 2014', sans-serif;
            font-size: 11px;
            letter-spacing: 2px;
            color: #999;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .report-text {
            margin-bottom: 15px;
        }

        .diagnosis-name-en {
            font-family: 'DIN 2014', sans-serif;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 1px;
            margin-top: 20px;
            line-height: 1.1;
        }

        .diagnosis-name-jp {
            font-size: 14px;
            font-weight: 500;
            margin-top: 5px;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .diagnosis-desc {
            font-size: 12px;
            opacity: 0.7;
            font-style: italic;
        }

        /* ç”»åƒè¡¨ç¤ºèª¿æ•´ */
        .material-image {
            width: 250px;
            height: 250px;
            object-fit: cover;
            border-radius: 50%;
            /* ä¸¸ãã™ã‚‹ */
            margin: 30px 0 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .material-id {
            font-family: 'DIN 2014', monospace;
            font-size: 12px;
            letter-spacing: 2px;
            color: #ccc;
            margin-bottom: 10px;
        }

        /* ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        #start-audio-indicator {
            font-size: 10px;
            color: #000;
            /* Fixed: White on White was invisible */
            margin-top: 15px;
            opacity: 0.6;
            letter-spacing: 1px;
            cursor: default;
            transition: opacity 0.3s;
            font-family: 'DIN 2014', sans-serif;
        }

        #start-audio-indicator:hover {
            opacity: 1;
        }

        #audio-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 2000;
            cursor: pointer;
            display: none;
            pointer-events: auto;
            /* Fixed: Parent #ui-layer has pointer-events: none */
        }

        .audio-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 6px 10px;
            font-family: 'DIN 2014', sans-serif;
            font-size: 10px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .audio-btn:hover {
            background: #fff;
            color: #000;
        }

        /* SKIPãƒœã‚¿ãƒ³ */
        #skip-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 6px 12px;
            font-family: 'DIN 2014', sans-serif;
            font-size: 11px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            z-index: 2000;
            display: none;
            /* åˆæœŸã¯éè¡¨ç¤º */
            pointer-events: auto;
        }

        #skip-btn:hover {
            background: #fff;
            color: #000;
        }

        /* TAP TO START */
        #tap-to-start {
            position: fixed;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'DIN 2014', sans-serif;
            font-size: 24px;
            letter-spacing: 4px;
            color: #333;
            animation: blink 1.5s infinite;
            display: none;
            z-index: 2000;
            pointer-events: none;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        /* ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼ä½ç½®èª¿æ•´ï¼ˆä¸è¦ã«ãªã£ãŸãŒå¿µã®ãŸã‚æ®‹ã™ã‹ã€å‰Šé™¤ï¼‰ */
        /* #speedometer.center-top { ... } å‰Šé™¤æ¸ˆã¿ */

        /* å­—å¹•ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå¿µã®ãŸã‚å®šç¾©ï¼‰ */
        #caption {
            position: fixed;
            top: 30%;
            /* ç”»é¢ä¸Šéƒ¨ã¸ç§»å‹• */
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            text-align: center;
            color: #000;
            /* é»’æ–‡å­—ã«å¤‰æ›´ */
            font-family: 'DIN 2014', 'Noto Sans JP', sans-serif;
            font-size: 14px;
            pointer-events: none;
            z-index: 1500;
            transition: opacity 0.5s;
        }
    </style>
</head>

<body>

    <!-- ãƒ‡ãƒã‚¤ã‚¹åˆ¶é™ç”»é¢ -->
    <div id="device-block"
        style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #fff; z-index: 9999; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px;">
        <div style="font-size: 24px; font-weight: bold; margin-bottom: 20px;">ğŸ“±</div>
        <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px;">ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„</div>
        <div style="font-size: 11px; color: #666; line-height: 1.6;">
            ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®<br>ç¸¦ç”»é¢å°‚ç”¨ã§ã™ã€‚
        </div>
    </div>

    <!-- æ¨ªç”»é¢è­¦å‘Š -->
    <div id="rotate-block"
        style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #fff; z-index: 9998; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px;">
        <div style="font-size: 24px; margin-bottom: 20px;">ğŸ”„</div>
        <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px;">ç¸¦ç”»é¢ã«ã—ã¦ãã ã•ã„</div>
        <div style="font-size: 11px; color: #666;">
            ç«¯æœ«ã‚’ç¸¦å‘ãã«å›è»¢ã—ã¦ãã ã•ã„
        </div>
    </div>

    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
    <div id="start-screen">
        <div class="glitch-overlay" id="glitch-overlay"></div>
        <div class="event-title">ç¬¬ä¸€å› ç¹Šç¶­ç”£æ¥­ç ”ç©¶å ±å‘Šä¼š<br>-è»Šã¨ç¹Šç¶­-</div>
        <div class="event-date">2026.02.28 SAT</div>

        <!-- ç·¯ç³¸ãƒ¢ãƒ¼ãƒ‰èª¬æ˜ -->
        <div id="weft-mode-info"
            style="display: none; background: rgba(0,0,0,0.05); padding: 15px; margin: 15px 0; border-left: 3px solid #333; text-align: left; max-width: 280px;">
            <div style="font-size: 11px; font-weight: bold; margin-bottom: 8px;">ã‚ãªãŸã¯ã€Œç·¯ç³¸ï¼ˆã‚ˆã“ã„ã¨ï¼‰ã€ã§ã™</div>
            <div style="font-size: 10px; color: #555; line-height: 1.5;">
                èª°ã‹ãŒç¹”ã£ãŸã€ŒçµŒç³¸ï¼ˆãŸã¦ã„ã¨ï¼‰ã€ãŒå¾…ã£ã¦ã„ã¾ã™ã€‚<br>
                ã‚ãªãŸã®èµ°ã‚ŠãŒã€Œç·¯ç³¸ã€ã¨ãªã‚Šã€<br>
                2äººã®ç³¸ãŒäº¤å·®ã—ã¦ã€1æšã®å¸ƒãŒå®Œæˆã—ã¾ã™ã€‚
            </div>
        </div>

        <button class="init-button" id="init-button">START</button>
        <div id="start-hint" style="font-size: 10px; color: #666; margin-top: 10px;">ã‚¿ãƒƒãƒ—ã—ã¦ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹</div>
        <div id="start-audio-indicator">( SOUND RECOMMENDED )</div>
    </div>

    <div id="scanlines"></div>
    <div id="whiteout-overlay"></div>
    <div id="ui-layer">
        <p id="caption">SYSTEM BOOTING...</p>
        <div id="audio-controls">
            <div id="game-audio-btn" class="audio-btn" onclick="toggleAudio()">SOUND ON</div>
        </div>
        <div id="skip-btn">SKIP &gt;&gt;</div>
        <div id="tap-to-start">TAP TO START</div>
    </div>
    <div id="speedometer">
        <div class="label">SPEED</div>
        <div class="speed"><span id="speedValue">0</span><span class="unit">km/h</span></div>
    </div>
    <canvas id="gameCanvas"></canvas>

    <!-- æ“ä½œãƒ’ãƒ³ãƒˆ -->
    <div id="control-hint"
        style="display: none; position: fixed; bottom: 60%; left: 0; right: 0; pointer-events: none; z-index: 50;">
        <div style="display: flex; justify-content: center; align-items: center; gap: 80px; opacity: 0.7;">
            <div id="hint-left"
                style="font-size: 60px; font-weight: 100; color: #333; animation: hintPulse 1.5s ease-in-out infinite;">
                â€¹
            </div>
            <div style="font-size: 11px; color: #666; text-align: center; letter-spacing: 2px;">
                DRAG or â† â†’
            </div>
            <div id="hint-right"
                style="font-size: 60px; font-weight: 100; color: #333; animation: hintPulse 1.5s ease-in-out infinite 0.3s;">
                â€º
            </div>
        </div>
    </div>
    <style>
        @keyframes hintPulse {

            0%,
            100% {
                opacity: 0.3;
                transform: translateX(0);
            }

            50% {
                opacity: 0.8;
            }
        }

        #hint-left {
            animation: hintLeft 1.5s ease-in-out infinite;
        }

        #hint-right {
            animation: hintRight 1.5s ease-in-out infinite;
        }

        @keyframes hintLeft {

            0%,
            100% {
                opacity: 0.3;
                transform: translateX(0);
            }

            50% {
                opacity: 0.8;
                transform: translateX(-10px);
            }
        }

        @keyframes hintRight {

            0%,
            100% {
                opacity: 0.3;
                transform: translateX(0);
            }

            50% {
                opacity: 0.8;
                transform: translateX(10px);
            }
        }
    </style>


    <!-- çµæœç”»é¢ -->
    <div id="result-screen">
        <!-- Retry Button (Top Right) -->
        <button onclick="resetUserData()"
            style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: #999; font-family: 'DIN 2014', sans-serif; font-size: 10px; cursor: pointer; letter-spacing: 0.1em; z-index: 200; opacity: 0.7;">
            RETRY
        </button>
        <div class="header" style="margin-top: 30px;">DRIVING RESULT</div>
        <div style="font-size: 10px; color: #666; margin-bottom: 20px;">èµ°è¡Œè§£æçµæœ</div>

        <div class="loading" id="loading-text">ANALYZING MATERIAL DATA...</div>

        <!-- ç”»åƒ -->
        <img id="material-image" class="material-image" style="display: none;" />

        <!-- ãƒãƒ†ãƒªã‚¢ãƒ«ID -->
        <div class="material-id" id="material-id" style="display: none;"></div>

        <!-- VIPç”¨ãƒã‚±ãƒƒãƒˆãƒ›ãƒ«ãƒ€ãƒ¼æƒ…å ± -->
        <div id="vip-ticket-holder" style="display: none; width: 100%; text-align: center; margin: 10px 0 25px 0;">
            <div style="font-size: 9px; color: #888; letter-spacing: 0.2em; margin-bottom: 4px;">TICKET HOLDER</div>
            <div id="vip-holder-name"
                style="font-size: 18px; font-weight: bold; color: #000; letter-spacing: 0.05em; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 10px 0; width: 80%; margin: 0 auto;">
            </div>
        </div>

        <!-- çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
        <div id="analysis-report" style="display: none;"></div>



        <!-- äºˆç´„ãƒœã‚¿ãƒ³ï¼ˆã¾ãŸã¯ãƒã‚±ãƒƒãƒˆä¿å­˜ãƒœã‚¿ãƒ³ï¼‰ -->
        <button class="reserve-btn" id="reserve-btn" style="display: none;" onclick="goToReservation()">RESERVE
            TICKET</button>
        <button id="calendar-btn"
            style="display: none; margin-top: 8px; background: none; border: 1px solid #ddd; color: #888; padding: 10px 20px; font-size: 9px; letter-spacing: 0.1em; cursor: pointer; width: 160px; font-family: 'DIN 2014', sans-serif;"
            onclick="addToCalendar()">ADD TO CALENDAR</button>

        <!-- ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»æ‹›å¾…ã‚¨ãƒªã‚¢ (çµ±åˆç‰ˆ) -->
        <div id="collab-section"
            style="margin-top: 25px; padding: 25px; background: #f8f8f8; border-radius: 4px; display: none; width: 85%; max-width: 500px; text-align: center;">

            <!-- A. çµŒç³¸ãƒ¢ãƒ¼ãƒ‰ (ä¸€èˆ¬å®¢ãƒ»å®Œäº†æ™‚) -->
            <div id="warp-mode-actions" style="display: none;">
                <div style="font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #222;">
                    COMPLETE THE TEXTILE
                </div>
                <div style="font-size: 11px; color: #555; line-height: 1.6; margin-bottom: 20px;">
                    ã“ã®å¸ƒã¯ã¾ã æœªå®Œæˆï¼ˆçµŒç³¸ã®ã¿ï¼‰ã§ã™ã€‚<br>
                    æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’é€ã£ã¦ã€èª°ã‹ã«ã€Œç·¯ç³¸ã€ã‚’ç¹”ã£ã¦ã‚‚ã‚‰ã„ã¾ã—ã‚‡ã†ã€‚<br>
                    <div
                        style="border: 1px solid #000; color: #000; padding: 10px; margin-top: 12px; font-weight: bold; font-size: 10px;">
                        SPECIAL REWARD<br>
                        ãƒšã‚¢ã§å®Œæˆã—ãŸç”»é¢ã‚’ä¼šå ´ã§è¦‹ã›ã‚‹ã¨<br>
                        é™å®šã‚¹ãƒ†ãƒƒã‚«ãƒ¼ã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ
                    </div>
                </div>

                <!-- Invite Share Buttons -->
                <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                    <button class="share-btn" onclick="shareInviteToTwitter()"
                        style="background: #000; color: #fff; border: none;">
                        Post to X (Invite Weaver)
                    </button>
                    <button class="share-btn" onclick="shareInviteToLINE()"
                        style="background: #06c755; color: #fff; border: none;">
                        Send via LINE
                    </button>
                </div>

                <!-- Manual Copy -->
                <div style="margin-top: 15px;">
                    <button onclick="copyInviteLink()"
                        style="background:none; border:none; text-decoration:underline; font-size:10px; color:#666; cursor:pointer;">
                        Copy Invite Link
                    </button>
                    <input type="text" id="invite-link-input" readonly style="position:absolute; left:-9999px;">
                </div>
            </div>

            <!-- B. ç·¯ç³¸ãƒ¢ãƒ¼ãƒ‰ (ã‚³ãƒ©ãƒœå®¢ãƒ»å®Œäº†æ™‚) -->
            <div id="weft-mode-result"
                style="display: none; border-top: 1px dashed #ccc; padding-top: 20px; margin-top: 15px;">
                <div style="font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #222;">
                    TEXTILE COMPLETED
                </div>
                <div style="font-size: 11px; color: #333; margin-bottom: 15px;">
                    äºŒäººã®ç³¸ãŒäº¤å·®ã—ã€ä¸–ç•Œã«ä¸€ã¤ã®å¸ƒãŒå®Œæˆã—ã¾ã—ãŸã€‚<br>
                    <span style="font-size:0.9em; color:#666;">çµŒç³¸: HOST / ç·¯ç³¸: YOU</span>
                    <div
                        style="border: 1px solid #000; color: #000; padding: 10px; margin-top: 12px; font-weight: bold; font-size: 10px;">
                        SPECIAL REWARD<br>
                        ã“ã®ç”»é¢ã‚’ã‚¤ãƒ™ãƒ³ãƒˆå½“æ—¥ã®å—ä»˜ã§æç¤ºã—ã€<br>
                        é™å®šã‚¹ãƒ†ãƒƒã‚«ãƒ¼ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ã€‚
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                    <!-- Screenshot Instruction -->
                    <div
                        style="width: 100%; text-align: center; border: 2px solid #000; padding: 15px; box-sizing: border-box; background: #fff; margin-bottom: 5px;">
                        <div style="font-size: 11px; font-weight: bold; letter-spacing: 0.1em;">SCREENSHOT THIS SCREEN
                        </div>
                        <div style="font-size: 9px; color: #666; margin-top: 5px; line-height: 1.4;">
                            ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’å«ã‚ãŸã“ã®ç”»é¢å…¨ä½“ã‚’<br>
                            ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
                        </div>
                    </div>

                    <button class="share-btn" onclick="reportToHostLINE()"
                        style="width: 100%; background: #06c755; color: #fff; border: none;">
                        REPORT TO HOST (LINE)
                    </button>
                    <div style="font-size:10px; color:#888; margin-bottom: 5px;">
                        â€»ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’LINEã§é€ã£ã¦ãã ã•ã„
                    </div>

                    <button class="share-btn" onclick="shareToTwitter()"
                        style="width: 100%; background: #fff; color: #333; border: 1px solid #ddd;">
                        Post to X
                    </button>
                </div>
            </div>

            <!-- C. VIPãƒ¢ãƒ¼ãƒ‰ -->
            <div id="vip-mode-result"
                style="display: none; border-top: 1px solid #000; padding-top: 20px; margin-top: 15px;">
                <div style="font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #000;">
                    YOUR TICKET IS READY
                </div>
                <div style="font-size: 11px; color: #333; margin-bottom: 20px; line-height: 1.6;">
                    ã‚ãªãŸã ã‘ã®ãƒ†ã‚­ã‚¹ã‚¿ã‚¤ãƒ«ãŒå®Œæˆã—ã¾ã—ãŸã€‚<br>
                    ã“ã‚ŒãŒå½“æ—¥ã®å…¥å ´ãƒã‚±ãƒƒãƒˆã¨ãªã‚Šã¾ã™ã€‚<br>
                    <span style="color:#666; font-size:10px;">â€»å—ä»˜ã«ã¦ã“ã®ç”»é¢ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ã”æç¤ºãã ã•ã„ã€‚</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                    <!-- Screenshot Instruction -->
                    <div
                        style="width: 100%; text-align: center; border: 2px solid #000; padding: 15px; box-sizing: border-box; background: #fff; margin-bottom: 5px;">
                        <div style="font-size: 11px; font-weight: bold; letter-spacing: 0.1em;">SCREENSHOT THIS SCREEN
                        </div>
                        <div style="font-size: 9px; color: #666; margin-top: 5px; line-height: 1.4;">
                            ãŠåå‰ã¨ãƒ†ã‚­ã‚¹ã‚¿ã‚¤ãƒ«ãŒè¡¨ç¤ºã•ã‚ŒãŸ<br>
                            ã“ã®ç”»é¢å…¨ä½“ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
                        </div>
                    </div>

                    <button class="share-btn" onclick="shareAttendanceToTwitter()"
                        style="width: 100%; background: #fff; color: #333; border: 1px solid #000;">
                        SHARE ATTENDANCE
                    </button>

                    <button onclick="shareToInstagram()"
                        style="background:none; border:none; text-decoration:underline; font-size:9px; color:#999; cursor:pointer; margin-top: 5px;">
                        Download Textile Graphic Only
                    </button>
                </div>
            </div>

        </div>

        <!-- å…±é€šè©³ç´°ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="event-detail-section"
            style="margin-top: 50px; padding-top: 40px; border-top: 1px solid #000; width: 90%; max-width: 600px; text-align: left; font-family: 'DIN 2014', 'Noto Sans JP', sans-serif;">

            <!-- Link Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 40px; justify-content: center; flex-wrap: wrap;">
                <a href="https://mautextileindustrylab.peatix.com/" target="_blank"
                    style="text-decoration: none; color: #fff; background: #000; padding: 10px 20px; font-size: 11px; font-weight: bold; letter-spacing: 0.1em; border-radius: 2px;">PEATIX</a>
                <a href="https://www.instagram.com/mau_textile_industry/" target="_blank"
                    style="text-decoration: none; color: #000; background: #fff; border: 1px solid #000; padding: 10px 20px; font-size: 11px; font-weight: bold; letter-spacing: 0.1em; border-radius: 2px;">INSTAGRAM</a>
                <a href="https://note.com/mautis" target="_blank"
                    style="text-decoration: none; color: #000; background: #fff; border: 1px solid #000; padding: 10px 20px; font-size: 11px; font-weight: bold; letter-spacing: 0.1em; border-radius: 2px;">NOTE</a>
            </div>

            <!-- Event Concept -->
            <div style="margin-bottom: 40px;">
                <h3 style="font-size: 16px; margin-bottom: 20px; letter-spacing: 0.1em;">EVENT INFORMATION</h3>
                <div style="font-size: 14px; font-weight: bold; margin-bottom: 15px;">ç¬¬ä¸€å› ç¹Šç¶­ç”£æ¥­ç ”ç©¶å ±å‘Šä¼š -è»Šã¨ç¹Šç¶­-</div>
                <p style="font-size: 11px; line-height: 1.8; color: #333; margin-bottom: 15px;">
                    ç¹Šç¶­ã«ã¯ã€ç‰©èªãŒã‚ã‚Šã¾ã™ã€‚<br>
                    ä½•åº¦ã‚‚ä½¿ã‚ã‚Œã€å‘³ã‚ã„ã‚’å¸¯ã³ãŸç¹Šç¶­ã€‚èª°ã«ã‚‚è§¦ã‚Œã‚‰ã‚Œãšã€å½¹ç›®ã‚’æœãŸã›ãªã„ã¾ã¾å»ƒæ£„ã•ã‚Œã‚‹ç¹Šç¶­ã€‚<br><br>
                    è»Šã®ä¸­ã«ã‚‚ã€ã²ã£ãã‚Šã¨æ¯ã¥ãç¹Šç¶­ãŒã‚ã‚Šã¾ã™ã€‚ã‚·ãƒ¼ãƒˆã€ãƒ•ãƒ­ã‚¢ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€ã‚¯ãƒƒã‚·ãƒ§ãƒ³ã€‚ç§ãŸã¡ã¯ã€ãã®ç‰©èªã‚’ä¸å¯§ã«ã™ãã„ä¸Šã’ã€ç¹Šç¶­ãŒæŒã¤æ–°ãŸãªå¯èƒ½æ€§ã‚’ç´¡ã„ã§ã„ãã¾ã™ã€‚
                </p>
                <p style="font-size: 11px; line-height: 1.8; color: #333;">
                    æœ¬ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€æ­¦è”µé‡ç¾è¡“å¤§å­¦
                    ç¹Šç¶­ç”£æ¥­ç ”ç©¶ä¼šã«ã‚ˆã‚‹åˆã®ç ”ç©¶æˆæœç™ºè¡¨ã®å ´ã§ã™ã€‚ãƒˆãƒ¨ã‚¿ç´¡ç¹”ã€ŒRE:TERRACEã€ã‹ã‚‰ã®ç´ ææä¾›ã‚’å—ã‘ã€è‡ªå‹•è»Šç”¨ç¹Šç¶­ç´ æã‚’ç”¨ã„ãŸãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ã‚·ãƒ§ãƒ¼ã€ãŠã‚ˆã³ä½œå“å±•ç¤ºã‚’è¡Œã„ã¾ã™ã€‚
                </p>
            </div>

            <!-- Practical Details Grid -->
            <div
                style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 40px; padding: 20px; background: #f9f9f9; border-radius: 4px;">
                <div>
                    <div style="font-size: 10px; color: #888; margin-bottom: 5px; font-weight: bold;">DATE & TIME</div>
                    <div style="font-size: 12px;">2026.02.28 SAT</div>
                    <div style="font-size: 11px; color: #555; margin-top: 5px;">
                        17:00 OPEN / 17:30 FASHION SHOW<br>
                        17:00 - 18:30 EXHIBITION
                    </div>
                </div>
                <div>
                    <div style="font-size: 10px; color: #888; margin-bottom: 5px; font-weight: bold;">VENUE</div>
                    <div style="font-size: 12px;">EVENT SPACE "MATERIAL"</div>
                    <div style="font-size: 10px; color: #555; margin-top: 3px;">æ±äº¬éƒ½æ‰ä¸¦åŒºé«˜å††å¯ºå—4-4-11 (é«˜å††å¯ºé§…å¾’æ­©5åˆ†)</div>
                </div>
                <div>
                    <div style="font-size: 10px; color: #888; margin-bottom: 5px; font-weight: bold;">ADMISSION &
                        RESERVE
                    </div>
                    <div style="font-size: 12px;">500 JPY <span style="font-size: 10px; color:#888;">(CASH /
                            PAYPAY)</span>
                    </div>
                    <div style="font-size: 10px; color: #555; margin-top: 5px; font-weight: bold;">
                        â€»äº‹å‰äºˆç´„ç‰¹å…¸ï¼šå½“æ—¥ä¼šå ´ã«ã¦ã€Œè¨˜å¿µã‚¹ãƒ†ãƒƒã‚«ãƒ¼ã€ã‚’é€²å‘ˆã€‚
                    </div>
                </div>
            </div>

            <!-- About Sections -->
            <div style="margin-bottom: 40px; font-size: 10px; line-height: 1.7; color: #666;">
                <div style="margin-bottom: 25px;">
                    <div style="font-weight: bold; color: #000; margin-bottom: 8px;">ç¹Šç¶­ç”£æ¥­ç ”ç©¶ä¼šã«ã¤ã„ã¦</div>
                    æ­¦è”µé‡ç¾è¡“å¤§å­¦ã‚’æ‹ ç‚¹ã¨ã™ã‚‹ã€ç¹Šç¶­ç”£æ¥­ã«é–¢ã™ã‚‹ç ”ç©¶å®Ÿé¨“æ©Ÿé–¢ã€‚ã€Œç¹Šç¶­ã€ã‚’ç¤¾ä¼šã‚„ç”£æ¥­ã‚’æ§‹æˆã™ã‚‹ã€ŒåŸºç›¤ã€ã¨ã—ã¦æ‰ãˆç›´ã—ã€ç•°ãªã‚‹é ˜åŸŸã®æŠ€è¡“ã¨è¦–ç‚¹ã‚’äº¤å·®ã•ã›ãªãŒã‚‰ã€ç”£æ¥­ã®æ–°ã—ã„å¯èƒ½æ€§ã‚’ç™ºè¦‹ã—ã¦ã„ãã¾ã™ã€‚
                </div>
                <div style="margin-bottom: 25px;">
                    <div style="font-weight: bold; color: #000; margin-bottom: 8px;">ãƒˆãƒ¨ã‚¿ç´¡ç¹” RE:TERRACEã«ã¤ã„ã¦</div>
                    è‡ªå‹•è»Šç”¨ã‚·ãƒ¼ãƒˆãƒ»å†…è£…ã‚’ç”Ÿç”£ã™ã‚‹ãƒˆãƒ¨ã‚¿ç´¡ç¹”ãŒæ‰‹æ›ã‘ã‚‹ã‚¢ãƒƒãƒ—ã‚µã‚¤ã‚¯ãƒ«ãƒ–ãƒ©ãƒ³ãƒ‰ã€‚ç”Ÿç”£å·¥ç¨‹ã§ç”Ÿã˜ã‚‹å»ƒæ£„äºˆå®šã®ç¹Šç¶­ç´ æã‚’æ–°ãŸãªè£½å“ã¨ã—ã¦ã‚ˆã¿ãŒãˆã‚‰ã›ã‚‹å–çµ„ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
                </div>
            </div>

            <!-- Footer Small -->
            <div
                style="border-top: 1px solid #eee; padding-top: 20px; margin-bottom: 50px; font-size: 9px; color: #999; text-align: center; letter-spacing: 0.1em;">
                <div style="margin-bottom: 5px;">ORGANIZER: MUSASHINO ART UNIVERSITY - TEXTILE INDUSTRY LABORATORY</div>
                <div style="margin-bottom: 15px;">SUPPORT: TOYOTA BOSHOKU CORPORATION / ICONIA HOSPITALITY K.K.</div>
                <div>CONTACT: mau.textile.industry@gmail.com</div>
            </div>

        </div>

    </div>

    <!-- ãƒ†ã‚­ã‚¹ã‚¿ã‚¤ãƒ«ç”Ÿæˆç”¨ é«˜è§£åƒåº¦Canvas (ä¸å¯è¦–) -->
    <canvas id="textileCanvas" width="2048" height="2048" style="display:none;"></canvas>
    </div>

    <script src="vip_list.js"></script>
    <script>
        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢ã«è¡¨ç¤º
        window.onerror = function (msg, url, line, col, error) {
            const caption = document.getElementById('caption');
            if (caption) caption.innerHTML = `<span style="color:red; font-size:12px;">ERROR: ${msg}<br>Line: ${line}</span>`;
            return false;
        };

        // --- é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆtrue: PCã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰ ---
        const DEV_MODE = true;  // æœ¬ç•ªæ™‚ã¯ false ã«å¤‰æ›´

        // --- ãƒ‡ãƒã‚¤ã‚¹åˆ¶é™ãƒã‚§ãƒƒã‚¯ ---
        function checkDeviceAccess() {
            if (DEV_MODE) return;  // é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã¯ã‚¹ã‚­ãƒƒãƒ—

            const deviceBlock = document.getElementById('device-block');
            const rotateBlock = document.getElementById('rotate-block');
            const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isPortrait = window.innerHeight > window.innerWidth;

            // PCæ¤œå‡º
            if (!isMobileDevice) {
                deviceBlock.style.display = 'flex';
                return;
            } else {
                deviceBlock.style.display = 'none';
            }

            // æ¨ªç”»é¢æ¤œå‡º
            if (!isPortrait) {
                rotateBlock.style.display = 'flex';
            } else {
                rotateBlock.style.display = 'none';
            }
        }

        // åˆæœŸãƒã‚§ãƒƒã‚¯ï¼†ãƒªã‚µã‚¤ã‚ºæ™‚ã«å†ãƒã‚§ãƒƒã‚¯
        checkDeviceAccess();
        window.addEventListener('resize', checkDeviceAccess);
        window.addEventListener('orientationchange', checkDeviceAccess);

        // --- Audio Control ---
        let isMuted = false;
        function toggleAudio() {
            isMuted = !isMuted;
            const bgm = window.bgm;
            const motor = window.motor;
            const narration = window.narration;

            if (bgm) bgm.muted = isMuted;
            if (motor) motor.muted = isMuted;
            if (narration) narration.muted = isMuted;

            const text = isMuted ? '( SOUND OFF )' : '( SOUND ON )';
            const gameText = isMuted ? 'SOUND OFF' : 'SOUND ON'; // HUDã¯ã‚·ãƒ³ãƒ—ãƒ«ã«

            const indicator = document.getElementById('start-audio-indicator');
            if (indicator) indicator.innerHTML = text;

            const gameBtn = document.getElementById('game-audio-btn');
            if (gameBtn) {
                gameBtn.innerHTML = gameText;
                gameBtn.style.opacity = isMuted ? '0.5' : '1.0';
            }
        }

        // --- ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: ç·¯ç³¸ãƒ¢ãƒ¼ãƒ‰æ¤œå‡º & VIPåˆ¤å®š ---
        window.isWeftMode = false;
        window.warpDataFromUrl = null;
        window.isVip = false;
        window.vipData = null;

        // VIPãƒªã‚¹ãƒˆ (å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿)
        // vip_list.js ã§ window.VIP_LIST ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™
        const VIP_LIST = window.VIP_LIST || {};

        // --- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼å–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
        function getStorageKey() {
            const urlParams = new URLSearchParams(window.location.search);
            const vipId = urlParams.get('vip');
            const warpParam = urlParams.get('warp');

            if (vipId && VIP_LIST[vipId]) {
                return `mautil_result_${vipId}`;
            } else if (warpParam) {
                // æ‹›å¾…ãƒªãƒ³ã‚¯(ç·¯ç³¸ãƒ¢ãƒ¼ãƒ‰)ã®å ´åˆã€ãƒªãƒ³ã‚¯ã”ã¨ã«ã‚­ãƒ¼ã‚’åˆ†ã‘ã‚‹ (å…ˆé ­12æ–‡å­—ã‚’ãƒãƒƒã‚·ãƒ¥ä»£ã‚ã‚Šã«)
                const hash = warpParam.substring(0, 12).replace(/[^a-zA-Z0-9]/g, '');
                return `mautil_result_weft_${hash}`;
            } else {
                // é€šå¸¸ã®ãƒ›ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤
                return `mautil_result_guest`;
            }
        }

        function restoreFromStorage() {
            const urlParams = new URLSearchParams(window.location.search);

            // 1. VIPåˆ¤å®š
            const vipId = urlParams.get('vip');
            if (vipId && VIP_LIST[vipId]) {
                window.isVip = true;
                window.vipData = VIP_LIST[vipId];
                console.log('VIPãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•:', window.vipData);

                // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®è¡¨ç¤ºæ›´æ–°
                const eventTitle = document.querySelector('#start-screen .event-title');
                const eventDate = document.querySelector('#start-screen .event-date');

                if (eventTitle) {
                    eventTitle.innerHTML = `<span style="font-size: 0.6em; display:block; margin-bottom:5px; opacity:0.7;">WELCOME</span>${window.vipData.name}<br><span style="font-size: 0.5em; opacity: 0.8;">- ${window.vipData.role} -</span>`;
                }
                if (eventDate) {
                    eventDate.style.borderTop = "none";
                    eventDate.innerHTML = "YOUR EXCLUSIVE TICKET RESERVATION";
                }
            }

            // 2. ç·¯ç³¸ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š (VIPã§ãªã„å ´åˆã®ã¿æœ‰åŠ¹)
            const warpParam = urlParams.get('warp');
            if (!window.isVip && warpParam) {
                try {
                    const decoded = atob(warpParam);
                    const parsed = JSON.parse(decoded);
                    // å¾©å…ƒï¼ˆçŸ­ç¸®ã‚­ãƒ¼å¯¾å¿œï¼‰
                    window.warpDataFromUrl = decompressWarpData(parsed);

                    window.isWeftMode = true;
                    console.log('ç·¯ç³¸ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•:', window.warpDataFromUrl);

                    // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«ç·¯ç³¸ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
                    const weftInfo = document.getElementById('weft-mode-info');
                    const startHint = document.getElementById('start-hint');
                    if (weftInfo) weftInfo.style.display = 'block';
                    if (startHint) startHint.innerHTML = 'ã‚¿ãƒƒãƒ—ã—ã¦ç·¯ç³¸ã‚’ç¹”ã‚Šå§‹ã‚ã‚‹';
                } catch (e) {
                    console.error('çµŒç³¸ãƒ‡ãƒ¼ã‚¿ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—:', e);
                }
            }

            // 3. éå»ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ç¢ºèª (Persistence)
            const storageKey = getStorageKey();
            const savedDataJson = localStorage.getItem(storageKey);

            if (savedDataJson) {
                try {
                    const savedData = JSON.parse(savedDataJson);
                    // --- å¾©å…ƒã‚¹ã‚­ãƒƒãƒ—åˆ¤å®š (æ‹›å¾…ãƒªãƒ³ã‚¯è¸ã‚“ã æ™‚) ---
                    // ã‚‚ã—ã€Œç·¯ç³¸ãƒ¢ãƒ¼ãƒ‰(æ‹›å¾…)ã§èµ·å‹•ã€ã—ã¦ã„ã¦ã€ã‹ã¤ã€Œä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒç·¯ç³¸ãƒ¢ãƒ¼ãƒ‰ã®çµæœã§ã¯ãªã„ï¼ˆçµŒç³¸ã®çµæœï¼‰ã€ãªã‚‰
                    // å¾©å…ƒã›ãšã«æ–°è¦ã‚²ãƒ¼ãƒ  (ç·¯ç³¸ãƒ—ãƒ¬ã‚¤) ã‚’é–‹å§‹ã™ã‚‹ã€‚
                    // â€» savedData.playMode ãŒãªã„å ´åˆã¯å¤ã„ãƒ‡ãƒ¼ã‚¿(çµŒç³¸)ã¨ã¿ãªã™
                    // ä¿®æ­£: ãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•—æ™‚ãªã©ã‚‚è€ƒæ…®ã—ã€isWeftModeãƒ•ãƒ©ã‚°ã§ã¯ãªããƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æœ‰ç„¡ã§åˆ¤å®š
                    if (warpParam && savedData.playMode !== 'weft') {
                        console.log('æ‹›å¾…ãƒªãƒ³ã‚¯ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ãŸã‚ã€éå»ã®çµŒç³¸ãƒ‡ãƒ¼ã‚¿ã‚’ç„¡è¦–ã—ã¦æ–°è¦ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã€‚');
                        return false;
                    }

                    // å¿…é ˆãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
                    if (!savedData || !savedData.genParams) {
                        throw new Error("Invalid saved data");
                    }

                    console.log('ä¿å­˜ã•ã‚ŒãŸçµæœã‚’å¾©å…ƒ:', savedData);

                    // ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
                    window.genParams = savedData.genParams;
                    window.diagnosisResults = savedData.diagnosisResults;
                    if (savedData.diagnosisParams) window.diagnosisParams = savedData.diagnosisParams; // è©³ç´°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¾©å…ƒ
                    if (savedData.diagnosisParams) window.diagnosisParams = savedData.diagnosisParams; // è©³ç´°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¾©å…ƒ
                    if (savedData.vipData) window.vipData = savedData.vipData;
                    if (savedData.vipColors) window.vipColors = savedData.vipColors;

                    // ãƒ¢ãƒ¼ãƒ‰æƒ…å ±ã®å¾©å…ƒ (é‡è¦: ã“ã“ã§ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ã“ã¨ã§ãƒªãƒ­ãƒ¼ãƒ‰å¾©å…ƒã‚’æ‹…ä¿)
                    if (savedData.playMode === 'weft') {
                        window.isWeftMode = true;
                    }
                    if (savedData.playMode === 'vip') {
                        window.isVip = true;
                    }

                    // èµ·å‹•æ™‚å³ãƒªã‚¶ãƒ«ãƒˆç”»é¢ã¸
                    restoreResultScreen();
                    return true;
                } catch (e) {
                    console.error('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å¤±æ•— (è‡ªå‹•å‰Šé™¤):', e);
                    localStorage.removeItem(storageKey);
                }
            }
            return false;
        }

        // --- è¨­å®šã‚¨ãƒªã‚¢ ---
        // --- è¨­å®šã‚¨ãƒªã‚¢ (Game Configuration) ---
        const GameConfig = {
            renderScale: 0.5,      // ç”»è³ªèª¿æ•´ï¼ˆè»½ãã™ã‚‹ãŸã‚ã«åŠåˆ†ã§è¨ˆç®—ã—ã¦æ‹¡å¤§ï¼‰
            roadWidth: 2000,
            segmentLength: 200,
            rumbleLength: 3,
            fieldOfView: 100,
            cameraHeight: 300,
            drawDistance: 300,
            // ç‰©ç†æŒ™å‹•
            physics: {
                maxSpeed: 18000,   // æœ€é«˜é€Ÿåº¦ (1.5å€)
                accel: 23,         // åŠ é€Ÿåº¦ (1.5å€)
                breaking: -300,    // æ¸›é€Ÿåº¦ (1.5å€)
                decel: -75,        // è‡ªç„¶æ¸›é€Ÿ (1.5å€)
                offRoadDecel: -300,// ã‚³ãƒ¼ã‚¹ã‚¢ã‚¦ãƒˆæ¸›é€Ÿ (1.5å€)
                offRoadLimit: 3000,// ã‚³ãƒ¼ã‚¹ã‚¢ã‚¦ãƒˆåˆ¤å®šå¹… (1.5å€)
                speedMultiplier: 0.006 // ç§»å‹•ä¿‚æ•° (å…ƒã«æˆ»ã™ï¼šspeedè‡ªä½“ãŒå¢—ãˆã¦ã„ã‚‹ãŸã‚)
            }
        };

        // å¾Œæ–¹äº’æ›æ€§ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’å£Šã•ãªã„ãŸã‚ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰
        // â€»å¾ã€…ã« GameConfig.XXX ã«ç½®ãæ›ãˆã¦ã„ã
        const renderScale = GameConfig.renderScale;
        const roadWidth = GameConfig.roadWidth;
        const segmentLength = GameConfig.segmentLength;
        const rumbleLength = GameConfig.rumbleLength;
        const fieldOfView = GameConfig.fieldOfView;
        let cameraHeight = GameConfig.cameraHeight; // letã®ã¾ã¾
        const drawDistance = GameConfig.drawDistance;

        // --- ã‚¨ãƒ³ã‚¸ãƒ³å¤‰æ•° ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const caption = document.getElementById('caption');
        const speedValue = document.getElementById('speedValue');

        let width, height;
        let position = 0;
        let playerX = 0;
        let playerZ = 0;
        let speed = 0;

        // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆç‰©ç†ï¼‰
        const speedMultiplier = GameConfig.physics.speedMultiplier;
        const maxSpeed = GameConfig.physics.maxSpeed;
        const accel = GameConfig.physics.accel;
        const breaking = GameConfig.physics.breaking;
        const decel = GameConfig.physics.decel;
        const offRoadDecel = GameConfig.physics.offRoadDecel;
        const offRoadLimit = GameConfig.physics.offRoadLimit;

        let keyLeft = false;
        let keyRight = false;
        let keyFaster = true; // è‡ªå‹•ã‚¢ã‚¯ã‚»ãƒ«ON

        // ã‚¹ãƒãƒ›ã‚¿ãƒƒãƒåˆ¶å¾¡ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let isMobile = false;
        let lastTouchX = 0;
        let touchSteerDir = 0; // -1=å·¦, 0=ç›´é€², 1=å³

        // --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç† ---
        let gameState = 'start'; // 'start', 'playing', 'result'

        // --- ãƒ—ãƒ¬ã‚¤ãƒ‡ãƒ¼ã‚¿åé›† ---
        const gameDuration = 30000; // 30ç§’
        let gameStartTime = null;
        let gameEnded = false;
        let playData = {
            weaveType: 0,
            texture: 0,
            density: 0,
            steeringHistory: [],
            speedHistory: [],
            trajectory: [],
            collisionCount: 0,
            steeringFlipCount: 0, // è¿½åŠ : åˆæœŸåŒ–
            totalDistance: 0,
            itemCounts: { blue: 0, red: 0, green: 0, orange: 0 }
        };

        // è›‡è¡Œåº¦è¨ˆç®—ç”¨
        let lastPlayerX = 0;
        let steeringVariance = 0;
        let steeringInputSum = 0;
        let steeringFlipCount = 0;
        let lastSteerDir = 0;

        // ç”»åƒ
        // ç”»åƒ (Globals) - srcè¨­å®šã¯initã§è¡Œã†ã‹ã€ã“ã“ã§è¨­å®šã—ã¦Preloaderã§ç›£è¦–ã™ã‚‹
        const carImgStraight = new Image();
        const carImgLeft = new Image();
        const carImgRight = new Image();

        // è»Šã®ã‚«ãƒ©ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆã‚¢ã‚¤ãƒ†ãƒ å–å¾—ã§å¤‰åŒ–ï¼‰
        let carColorHue = 0;  // 0=é€šå¸¸, 180=é’, 330=èµ¤, 90=ç·‘, 30=ã‚ªãƒ¬ãƒ³ã‚¸
        let carColorSaturate = 1.0; // å½©åº¦

        // æœ€å¾Œã«å–å¾—ã—ãŸã‚«ãƒ©ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆçµæœç”»é¢ã«åæ˜ ï¼‰
        let lastCollectedColor = 'black';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é»’

        // éšœå®³ç‰©ç”»åƒ
        const obstacleSources = ['dram.png', 'dram2.png', 'wall.png', 'wall2.png'];
        const obstacleImgs = obstacleSources.map(src => new Image()); // ç©ºã®Imageã‚’ä½œæˆ

        // é“è·¯ãƒ‡ãƒ¼ã‚¿
        const segments = [];
        const totalSegments = 1600;

        // éšœå®³ç‰©ãƒ»ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿
        const obstacles = [];
        const items = []; // ã‚«ãƒ©ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ 

        // éŸ³å£°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (ã‚°ãƒ­ãƒ¼ãƒãƒ«äº‹å‰ç”Ÿæˆ)
        const audioAssets = {
            bgm: new Audio(),
            motor: new Audio(),
            narration: new Audio()
        };
        // è¨­å®š
        audioAssets.bgm.loop = true;
        audioAssets.bgm.volume = 0.5;
        audioAssets.motor.loop = true;
        audioAssets.motor.volume = 0.6;
        audioAssets.narration.volume = 1.0;

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã¸ç´ä»˜ã‘ (äº’æ›æ€§ç¶­æŒ)
        window.bgm = audioAssets.bgm;
        window.motor = audioAssets.motor;
        window.narration = audioAssets.narration;

        function initObstacles(startSegmentIndex = 0) {
            obstacles.length = 0;
            // éšœå®³ç‰©ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é…ç½® (æŒ‡å®šä½ç½®ä»¥é™)
            const count = 40;
            for (let i = 0; i < count; i++) {
                // é–‹å§‹ä½ç½®ã‹ã‚‰å…¨å‘¨ã®ç¯„å›²ã§é…ç½®
                const offset = Math.floor(Math.random() * totalSegments);
                const idx = (startSegmentIndex + offset) % totalSegments;

                // ç›®ã®å‰(ã‚¹ã‚¿ãƒ¼ãƒˆç›´å¾Œ)ã™ãã‚‹å ´åˆã¯é¿ã‘ã‚‹ (ä¾‹ãˆã° +50 ã‚»ã‚°ãƒ¡ãƒ³ãƒˆä»¥é™)
                if (Math.abs(idx - startSegmentIndex) < 50) continue;

                obstacles.push({
                    segmentIndex: idx,
                    x: (Math.random() - 0.5) * 1.5,
                    type: Math.floor(Math.random() * obstacleImgs.length),
                    hit: false
                });
            }
        }

        function initItems(startSegmentIndex = 0) {
            items.length = 0;
            // 6è‰²ã‚·ã‚¹ãƒ†ãƒ 
            const colors = ['monochrome', 'red', 'blue', 'green', 'orange', 'purple'];
            const count = 20;
            for (let i = 0; i < count; i++) {
                const offset = Math.floor(Math.random() * totalSegments);
                const idx = (startSegmentIndex + offset) % totalSegments;

                if (Math.abs(idx - startSegmentIndex) < 50) continue;

                items.push({
                    segmentIndex: idx,
                    x: (Math.random() - 0.5) * 1.8,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    hit: false,
                    floatOffset: Math.random() * Math.PI * 2
                });
            }
        }

        // --- æ•°å­¦é–¢æ•° ---
        function project(p, cameraX, cameraY, cameraZ, cameraDepth) {
            p.camera.x = (p.world.x || 0) - cameraX;
            p.camera.y = (p.world.y || 0) - cameraY;
            p.camera.z = (p.world.z || 0) - cameraZ;
            p.screen.scale = cameraDepth / p.camera.z;
            p.screen.x = Math.round((width / 2) + (p.screen.scale * p.camera.x * width / 2));
            p.screen.y = Math.round((height / 2) - (p.screen.scale * p.camera.y * height / 2));
            p.screen.w = Math.round((p.screen.scale * roadWidth * width / 2));
        }

        function easeIn(a, b, percent) { return a + (b - a) * Math.pow(percent, 2); }
        function easeOut(a, b, percent) { return a + (b - a) * (1 - Math.pow(1 - percent, 2)); }
        function easeInOut(a, b, percent) { return a + (b - a) * ((-Math.cos(percent * Math.PI) / 2) + 0.5); }

        // --- é“è·¯ç”Ÿæˆ ---
        function addSegment(curve) {
            const n = segments.length;
            segments.push({
                index: n,
                p1: { world: { z: n * segmentLength }, camera: {}, screen: {} },
                p2: { world: { z: (n + 1) * segmentLength }, camera: {}, screen: {} },
                curve: curve,
                color: Math.floor(n / rumbleLength) % 2 ? '#222' : '#111'
            });
        }

        function addRoad(enter, hold, leave, curve) {
            for (let n = 0; n < enter; n++) addSegment(easeIn(0, curve, n / enter));
            for (let n = 0; n < hold; n++) addSegment(curve);
            for (let n = 0; n < leave; n++) addSegment(easeInOut(curve, 0, n / leave));
        }

        function initRoad() {
            addRoad(50, 50, 50, 0);       // ç›´ç·š
            addRoad(50, 50, 50, 4);       // å³ã‚«ãƒ¼ãƒ–
            addRoad(50, 50, 50, -2);      // å·¦ã‚«ãƒ¼ãƒ–
            addRoad(50, 50, 50, 2);       // å³ã¸
            addRoad(50, 200, 50, 0);      // é•·ã„ç›´ç·š
            addRoad(50, 50, 50, -4);      // ãã¤ã„å·¦
            addRoad(100, 100, 100, 0);    // æœ€å¾Œã¯ç›´ç·š
        }

        // --- åˆæœŸåŒ– ---
        function init() {
            resize();
            window.addEventListener('resize', resize);

            // æ“ä½œç³»
            window.addEventListener('keydown', e => {
                if (gameState !== 'playing') return;
                if (e.key === 'ArrowLeft') keyLeft = true;
                if (e.key === 'ArrowRight') keyRight = true;
            });
            window.addEventListener('keyup', e => {
                if (e.key === 'ArrowLeft') keyLeft = false;
                if (e.key === 'ArrowRight') keyRight = false;
            });

            // ã‚¹ãƒãƒ›ã‚¿ãƒƒãƒåˆ¶å¾¡
            function updateTouchSteering(touchX) {
                const normalizedX = (touchX / width) * 2 - 1;
                touchSteerDir = Math.max(-1, Math.min(1, normalizedX));
            }

            canvas.addEventListener('touchstart', e => {
                if (gameState !== 'playing') return;
                isMobile = true;
                updateTouchSteering(e.touches[0].clientX);
            }, { passive: false });

            canvas.addEventListener('touchmove', e => {
                if (gameState !== 'playing') return;
                e.preventDefault();
                updateTouchSteering(e.touches[0].clientX);
            }, { passive: false });

            canvas.addEventListener('touchend', e => {
                if (gameState === 'ready') {
                    // READYçŠ¶æ…‹ãªã‚‰ã‚¿ãƒƒãƒ—ã§ã‚²ãƒ¼ãƒ é–‹å§‹
                    startGame();
                } else if (gameState === 'playing') {
                    touchSteerDir = 0;
                }
            });

            // PCç”¨ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—å¯¾å¿œï¼‰
            canvas.addEventListener('mousedown', e => {
                if (gameState === 'ready') {
                    startGame();
                }
            });

            // SKIPãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('skip-btn').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (gameState === 'opening') {
                    endOpening();
                }
            });

            // ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å‡¦ç†
            preloadAssets().then(() => {
                console.log('All assets loaded');

                // å¾©å…ƒè©¦è¡Œ
                if (restoreFromStorage()) {
                    // å¾©å…ƒæˆåŠŸãªã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å³æ¶ˆã—
                    const loader = document.getElementById('loading-overlay');
                    if (loader) {
                        loader.style.opacity = '0';
                        loader.style.display = 'none';
                    }
                } else {
                    // é€šå¸¸èµ·å‹•
                    const loader = document.getElementById('loading-overlay');
                    if (loader) {
                        loader.style.opacity = '0';
                        setTimeout(() => loader.style.display = 'none', 500);
                    }
                }
            });



            // BGMè¨­å®š (ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã§æ—¢ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿)

            // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®ãƒœã‚¿ãƒ³ - ã‚·ãƒ³ãƒ—ãƒ«ã‹ã¤å …ç‰¢ã«ãƒªãƒˆãƒ©ã‚¤å†ç”Ÿ
            document.getElementById('init-button').addEventListener('click', () => {
                const playAudio = (audio) => {
                    if (audio.readyState >= 3) { // HAVE_FUTURE_DATA
                        audio.play().catch(e => console.warn('Play failed', e));
                    } else {
                        // ä¸‡ãŒä¸€ãƒ­ãƒ¼ãƒ‰ãŒã¾ã ãªã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰å†ç”Ÿ
                        audio.load();
                        audio.play().catch(e => console.warn('Force load play failed', e));
                    }
                };

                playAudio(window.bgm);
                // playAudio(window.motor); // ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ã‹ã‚‰å†ç”Ÿã«å¤‰æ›´

                setTimeout(() => {
                    playAudio(window.narration);
                }, 2000);

                startGameTransition();
            });

            initRoad();
            initObstacles();
            initItems();

            requestAnimationFrame(loop);
        }

        // --- ã‚¢ã‚»ãƒƒãƒˆãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ ---
        function preloadAssets() {
            const progress = document.getElementById('loading-progress');
            let loadedCount = 0;
            const imagesToLoad = [
                { img: carImgStraight, src: 'car_straight.png' },
                { img: carImgLeft, src: 'car2_left.png' },
                { img: carImgRight, src: 'car2_right.png' }
            ];

            // éšœå®³ç‰©
            obstacleImgs.forEach((img, i) => {
                imagesToLoad.push({ img: img, src: obstacleSources[i] });
            });

            // éŸ³å£°ã‚½ãƒ¼ã‚¹å®šç¾©
            const audioSources = [
                { audio: window.bgm, src: 'bgm.wav' },
                { audio: window.motor, src: 'car_bgm.wav' },
                { audio: window.narration, src: 'ElevenLabs_2026-02-03T08_23_36_Relaxing Rachel - Calm & Soothing_pvc_sp75_s100_sb75_se27_b_m2.mp3' }
            ];

            const totalAssets = imagesToLoad.length + audioSources.length;

            const updateProgress = () => {
                loadedCount++;
                const pct = Math.floor((loadedCount / totalAssets) * 100);
                if (progress) progress.style.width = `${pct}%`;
            };

            const imagePromises = imagesToLoad.map(item => {
                return new Promise(resolve => {
                    item.img.onload = () => { updateProgress(); resolve(); };
                    item.img.onerror = () => { console.warn('Image load error:', item.src); updateProgress(); resolve(); };
                    item.img.src = item.src;
                });
            });

            // éŸ³å£°ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ (canplaythroughå¾…æ©Ÿ)
            const audioPromises = audioSources.map(item => {
                return new Promise(resolve => {
                    const onReady = () => {
                        updateProgress();
                        item.audio.removeEventListener('canplaythrough', onReady);
                        resolve();
                    };

                    item.audio.addEventListener('canplaythrough', onReady);
                    item.audio.addEventListener('error', (e) => {
                        console.warn('Audio load error:', item.src, e);
                        updateProgress(); // ã‚¨ãƒ©ãƒ¼ã§ã‚‚é€²è¡Œã•ã›ã‚‹
                        resolve();
                    });

                    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚»ãƒƒãƒˆãƒ»ãƒ­ãƒ¼ãƒ‰é–‹å§‹
                    item.audio.src = item.src;
                    item.audio.load();
                });
            });

            return Promise.all([...imagePromises, ...audioPromises]);
        }

        function startGameTransition() {
            const startScreen = document.getElementById('start-screen');
            startScreen.style.transition = 'opacity 0.5s';
            startScreen.style.opacity = '0';

            setTimeout(() => {
                startScreen.classList.add('hidden');
                startScreen.style.display = 'none'; // ç¢ºå®Ÿã«éè¡¨ç¤º
                // ã“ã“ã§ã„ããªã‚ŠstartGameã§ã¯ãªãã€Openingã‚’é–‹å§‹
                startOpening();
            }, 500);
        }

        // --- æ–°ã—ã„ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†é–¢æ•° ---

        function startOpening() {
            gameState = 'opening';
            gameStartTime = Date.now(); // è¿½åŠ : å­—å¹•ç”¨ã‚¿ã‚¤ãƒãƒ¼åˆæœŸåŒ–

            // è»Šã®è‰²ã‚’ç™½ï¼ˆãƒ¢ãƒã‚¯ãƒ­ï¼‰ã«ãƒªã‚»ãƒƒãƒˆ
            lastCollectedColor = 'monochrome';
            carColorHue = 0;
            carColorSaturate = 0;

            document.getElementById('audio-controls').style.display = 'block';
            document.getElementById('skip-btn').style.display = 'block';

            // ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼ä½ç½®èª¿æ•´ï¼ˆå¸¸æ™‚ä¸­å¤®ã«ãªã£ãŸã®ã§å‰Šé™¤ï¼‰
            // const speedMeter = document.getElementById('speedometer');
            // if (speedMeter) speedMeter.classList.add('center-top');

            // å­—å¹•åˆæœŸåŒ–
            const cap = document.getElementById('caption');
            if (cap) {
                cap.innerHTML = "SYSTEM BOOTING...";
                cap.style.opacity = '1';
            }

            // ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†æ¤œçŸ¥
            window.narration.onended = () => {
                if (gameState === 'opening') {
                    endOpening();
                }
            };

            // ã‚ªãƒ¼ãƒˆãƒ©ãƒ³é€Ÿåº¦è¨­å®š (ã‚†ã£ãã‚Š)
            speed = 100;

            // éšœå®³ç‰©ã¯ç©ºã«ã™ã‚‹
            obstacles.length = 0;
            items.length = 0;
        }

        function endOpening() {
            gameState = 'ready';
            document.getElementById('skip-btn').style.display = 'none';

            // ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼ä½ç½®æˆ»ã™ï¼ˆå¸¸æ™‚ä¸­å¤®ãªã®ã§å‰Šé™¤ï¼‰
            // const speedMeter = document.getElementById('speedometer');
            // if (speedMeter) speedMeter.classList.remove('center-top');

            // ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢
            window.narration.pause();
            window.narration.currentTime = 0;
            window.narration.onended = null;

            // TAP TO START è¡¨ç¤º
            const tapMsg = document.getElementById('tap-to-start');
            tapMsg.style.display = 'block';
        }

        function startGame() {
            // TAP TO START éè¡¨ç¤º
            document.getElementById('tap-to-start').style.display = 'none';

            gameState = 'playing';

            // ã‚¨ãƒ³ã‚¸ãƒ³éŸ³é–‹å§‹
            if (window.motor) {
                window.motor.play().catch(e => console.warn('Motor play failed', e));
            }

            gameStartTime = Date.now();
            lastTime = gameStartTime; // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ è¨ˆç®—ç”¨
            gameEnded = false;

            // ãƒ›ãƒ¯ã‚¤ãƒˆã‚¢ã‚¦ãƒˆãƒªã‚»ãƒƒãƒˆ
            const wo = document.getElementById('whiteout-overlay');
            if (wo) wo.style.opacity = '0';

            // éŸ³é‡ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå¾Œç”¨ï¼‰
            if (window.bgm) window.bgm.volume = 0.5;
            if (window.motor) window.motor.volume = 0.6;

            // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ/åˆæœŸåŒ–
            playData = {
                weaveType: 0,
                texture: 0,
                density: 0,
                steeringHistory: [],
                speedHistory: [],
                trajectory: [],
                collisionCount: 0,
                steeringFlipCount: 0, // è¿½åŠ : ãƒªã‚»ãƒƒãƒˆ
                totalDistance: 0,
                itemCounts: { blue: 0, red: 0, green: 0, orange: 0 }
            };
            lastPlayerX = playerX; // ç¾åœ¨ä½ç½®ã‚’ç¶­æŒ
            // steeringVariance = 0; // ãã®ã¾ã¾
            steeringInputSum = 0;
            steeringFlipCount = 0;
            lastSteerDir = 0;

            // ãƒã‚¸ã‚·ãƒ§ãƒ³ç¶­æŒ (position = 0 ã‚’å‰Šé™¤)
            // é“è·¯ç”Ÿæˆã‚‚ã—ãªã„ (initRoad å‰Šé™¤)

            // éšœå®³ç‰©ã¨ã‚¢ã‚¤ãƒ†ãƒ ã®ã¿å†é…ç½®ï¼ˆç¾åœ¨ã®ä½ç½®ã‚ˆã‚Šå…ˆã‹ã‚‰ï¼‰
            const currentSegIndex = Math.floor(position / segmentLength) % totalSegments;
            initObstacles(currentSegIndex);
            initItems(currentSegIndex);

            // è»Šã®ã‚«ãƒ©ãƒ¼ãƒªã‚»ãƒƒãƒˆ
            carColorHue = 0;
            carColorSaturate = 1.0;
            lastCollectedColor = 'monochrome';  // ãƒªã‚»ãƒƒãƒˆï¼ˆç™½ï¼é»’ç³¸ï¼‰
            window.glitchIntensity = 0; // ã‚°ãƒªãƒƒãƒåˆæœŸåŒ–

            // æ“ä½œãƒ’ãƒ³ãƒˆè¡¨ç¤ºï¼ˆ3ç§’å¾Œã«æ¶ˆãˆã‚‹ï¼‰
            const hint = document.getElementById('control-hint');
            if (hint) {
                hint.style.display = 'block';
                hint.style.opacity = '1';
                hint.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    hint.style.opacity = '0';
                    setTimeout(() => { hint.style.display = 'none'; }, 500);
                }, 4000); // 1500ã‹ã‚‰4000(4ç§’)ã«å»¶é•·
            }
        }

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            ctx.imageSmoothingEnabled = false;
        }

        // --- æç”»ãƒ«ãƒ¼ãƒ— ---
        function render() {
            // playing, opening, ready ã®ã„ãšã‚Œã‹ãªã‚‰æç”»ã™ã‚‹
            if (gameState !== 'playing' && gameState !== 'opening' && gameState !== 'ready') return;

            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, width, height);

            const baseSegment = segments[Math.floor(position / segmentLength) % segments.length];
            const basePercent = (position % segmentLength) / segmentLength;
            const playerSegment = segments[Math.floor((position + playerZ) / segmentLength) % segments.length];
            const playerPercent = ((position + playerZ) % segmentLength) / segmentLength;

            let dx = -(baseSegment.curve * basePercent);
            let x = 0;
            const cameraDepth = 1 / Math.tan((fieldOfView / 2) * Math.PI / 180);

            let maxy = height;
            const projected = new Array(totalSegments);

            for (let n = 0; n < drawDistance; n++) {
                const segment = segments[(baseSegment.index + n) % segments.length];

                segment.p1.camera.x = playerX * roadWidth;
                project(segment.p1, (playerX * roadWidth) - x, cameraHeight, position - (segment.index < baseSegment.index ? totalSegments * segmentLength : 0), cameraDepth);

                x += dx;
                dx += segment.curve;

                project(segment.p2, (playerX * roadWidth) - x - dx, cameraHeight, position - (segment.index < baseSegment.index ? totalSegments * segmentLength : 0), cameraDepth);

                if (segment.p1.camera.z <= cameraDepth || segment.p2.screen.y >= segment.p1.screen.y || segment.p2.screen.y >= maxy) continue;

                ctx.fillStyle = segment.color;
                ctx.beginPath();
                ctx.moveTo(segment.p1.screen.x - segment.p1.screen.w, segment.p1.screen.y);
                ctx.lineTo(segment.p2.screen.x - segment.p2.screen.w, segment.p2.screen.y);
                ctx.lineTo(segment.p2.screen.x + segment.p2.screen.w, segment.p2.screen.y);
                ctx.lineTo(segment.p1.screen.x + segment.p1.screen.w, segment.p1.screen.y);
                ctx.fill();

                if (n % 5 === 0) {
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(segment.p1.screen.x - segment.p1.screen.w, segment.p1.screen.y);
                    ctx.lineTo(segment.p2.screen.x - segment.p2.screen.w, segment.p2.screen.y);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(segment.p1.screen.x + segment.p1.screen.w, segment.p1.screen.y);
                    ctx.lineTo(segment.p2.screen.x + segment.p2.screen.w, segment.p2.screen.y);
                    ctx.stroke();
                }

                ctx.strokeStyle = '#444';
                ctx.lineWidth = 1;
                ctx.setLineDash([10, 10]);
                ctx.beginPath();
                ctx.moveTo(segment.p1.screen.x, segment.p1.screen.y);
                ctx.lineTo(segment.p2.screen.x, segment.p2.screen.y);
                ctx.stroke();
                ctx.setLineDash([]);

                projected[segment.index] = {
                    x: segment.p2.screen.x,
                    y: segment.p2.screen.y,
                    w: segment.p2.screen.w
                };
                maxy = segment.p1.screen.y;
            }

            // éšœå®³ç‰©æç”»
            obstacles.forEach(obstacle => {
                // OPENING/READYä¸­ã¯éšœå®³ç‰©ã‚’æç”»ã—ãªã„ï¼ˆãã‚‚ãã‚‚ç©ºã ãŒå¿µã®ãŸã‚ï¼‰
                if (gameState !== 'playing') return;

                if (obstacle.hit) return;
                const p = projected[obstacle.segmentIndex];
                if (!p) return;

                const obstacleScreenX = p.x + (obstacle.x * p.w);
                const obstacleScreenY = p.y;

                // ç”»åƒæç”»
                const img = obstacleImgs[obstacle.type];
                let obsWidth = 0;
                let obsHeight = 0;

                if (img && img.complete && img.width > 0) {
                    // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼šé“è·¯å¹…(p.w)ã®25%ç¨‹åº¦ã«åˆã‚ã›ã‚‹
                    const targetWidth = p.w * 0.4;
                    const scale = targetWidth / img.width;
                    obsWidth = targetWidth;
                    obsHeight = img.height * scale;

                    const drawX = obstacleScreenX - obsWidth / 2;
                    const drawY = obstacleScreenY - obsHeight * 1; // ã‚ˆã‚Šè·¯é¢ã«è¿‘ã

                    ctx.drawImage(img, drawX, drawY, obsWidth, obsHeight);
                } else {
                    // èª­ã¿è¾¼ã¿å‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    const radius = Math.max(6, 0.5 * p.w * 0.03 * 300);
                    ctx.fillStyle = '#f00';
                    ctx.beginPath();
                    ctx.arc(obstacleScreenX, obstacleScreenY, radius, 0, Math.PI * 2);
                    ctx.fill();
                    obsWidth = radius * 2;
                }

                // è¡çªåˆ¤å®š
                const playerScreenX = width / 2;
                const playerScreenY = height - 120;

                // åˆ¤å®šã‚¨ãƒªã‚¢ï¼ˆç”»åƒå¹…ã®40%ï¼‰
                const hitRadius = Math.max(20, obsWidth * 0.4);

                // Yåº§æ¨™åˆ¤å®š
                const inDepthRange = (obstacleScreenY > playerScreenY - 40) && (obstacleScreenY < playerScreenY + 60);

                if (inDepthRange && Math.abs(playerScreenX - obstacleScreenX) < hitRadius + 40) {
                    playData.collisionCount += 2;
                    obstacle.hit = true;
                    speed = Math.max(0, speed - 8000);

                    // ã‚°ãƒªãƒƒãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆç™ºå‹•
                    window.glitchIntensity = 1.0;

                    // è¡°çªæ¼”å‡ºï¼ˆç™½ã«æˆ»ã™ï¼‰
                    const flash = document.createElement('div');
                    flash.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.8);pointer-events:none;z-index:999;transition:opacity 0.15s;mix-blend-mode:normal;';
                    document.body.appendChild(flash);
                    requestAnimationFrame(() => {
                        flash.style.opacity = '0';
                        setTimeout(() => flash.remove(), 150);
                    });
                }
            });

            // ã‚¢ã‚¤ãƒ†ãƒ æç”»
            items.forEach(item => {
                if (item.hit) return;
                const p = projected[item.segmentIndex];
                if (!p) return;

                const floatY = Math.sin(Date.now() / 400 + item.floatOffset) * 3; // æºã‚Œæ§ãˆã‚
                const itemScreenX = p.x + (item.x * p.w);
                // é«˜ã•èª¿æ•´ï¼š1.5 -> 0.3 (ã ã„ã¶ä¸‹ã’ã‚‹)
                const itemScreenY = p.y - p.w * 0.1 - floatY * (p.w * 0.005);
                const size = p.w * 0.05;

                ctx.save();
                ctx.translate(itemScreenX, itemScreenY);

                // 6è‰²ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆç™½èƒŒæ™¯ã§æ˜ ãˆã‚‹è‰²ï¼‰
                const colorMap = {
                    monochrome: { code: '#ffffff', glow: 'rgba(255, 255, 255, 0.8)' },
                    red: { code: '#e60012', glow: 'rgba(230, 0, 18, 0.6)' },
                    blue: { code: '#0066cc', glow: 'rgba(0, 102, 204, 0.6)' },
                    green: { code: '#009944', glow: 'rgba(0, 153, 68, 0.6)' },
                    orange: { code: '#ff6600', glow: 'rgba(255, 102, 0, 0.6)' },
                    purple: { code: '#6b0099', glow: 'rgba(107, 0, 153, 0.6)' }
                };
                const colorInfo = colorMap[item.color] || colorMap.monochrome;
                const colorCode = colorInfo.code;
                const glowCode = colorInfo.glow;

                ctx.shadowBlur = 30;
                ctx.shadowColor = colorCode;
                ctx.fillStyle = colorCode;
                ctx.beginPath();
                ctx.moveTo(0, -size);
                ctx.lineTo(size * 0.8, 0);
                ctx.lineTo(0, size);
                ctx.lineTo(-size * 0.8, 0);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.moveTo(0, -size * 0.5);
                ctx.lineTo(size * 0.4, 0);
                ctx.lineTo(0, size * 0.5);
                ctx.lineTo(-size * 0.4, 0);
                ctx.closePath();
                ctx.globalAlpha = 0.5;
                ctx.fill();

                ctx.restore();

                // å–å¾—åˆ¤å®š
                const playerScreenX = width / 2;
                const playerScreenY = height - 120;
                const distanceToItem = Math.hypot(playerScreenX - itemScreenX, playerScreenY - itemScreenY);

                if (distanceToItem < size + 100 && p.w > 10) {
                    if (playData && playData.itemCounts) {
                        playData.itemCounts[item.color] = (playData.itemCounts[item.color] || 0) + 1;
                    }
                    item.hit = true;

                    // æœ€å¾Œã«å–å¾—ã—ãŸè‰²ã‚’è¨˜éŒ²ï¼ˆçµæœç”»é¢ã§ä½¿ç”¨ï¼‰
                    lastCollectedColor = item.color;

                    // è»Šã®ã‚«ãƒ©ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´ï¼ˆ6è‰²å¯¾å¿œï¼‰
                    const carFilterMap = {
                        monochrome: { hue: 0, saturate: 0 },      // ç™½ï¼ˆå½©åº¦0ã§ç™½åŒ–å‡¦ç†ã¸ï¼‰
                        red: { hue: 330, saturate: 1.5 },
                        blue: { hue: 180, saturate: 1.5 },
                        green: { hue: 90, saturate: 1.5 },
                        orange: { hue: 30, saturate: 1.5 },
                        purple: { hue: 270, saturate: 1.5 }
                    };
                    const filter = carFilterMap[item.color] || carFilterMap.monochrome;
                    carColorHue = filter.hue;
                    carColorSaturate = filter.saturate;

                    try {
                        const originalRate = window.motor.playbackRate;
                        window.motor.playbackRate = 2.0;
                        setTimeout(() => window.motor.playbackRate = originalRate, 150);
                    } catch (e) { }
                }
            });

            // è»Šã®æç”»
            let currentCarImg = carImgStraight;
            if (isMobile) {
                if (touchSteerDir < -0.2) currentCarImg = carImgLeft;
                else if (touchSteerDir > 0.2) currentCarImg = carImgRight;
            } else {
                if (keyLeft) currentCarImg = carImgLeft;
                else if (keyRight) currentCarImg = carImgRight;
            }

            if (currentCarImg.complete) {
                let carScale = 0.4;
                if (cameraHeight < 800) carScale = 0.65;

                const carDisplayWidth = width * carScale;
                const ratio = currentCarImg.height / currentCarImg.width;
                const carDisplayHeight = carDisplayWidth * ratio;
                const carX = (width / 2) - (carDisplayWidth / 2);
                const bounce = Math.sin(Date.now() / 50) * 2;
                const carY = height - carDisplayHeight - 20 + bounce;

                ctx.save();
                ctx.beginPath();
                const shadowX = carX + carDisplayWidth / 2;
                const shadowY = height - 80 + bounce;
                const shadowRadiusX = carDisplayWidth * 0.45;
                const shadowRadiusY = 35;
                ctx.ellipse(shadowX, shadowY, shadowRadiusX, shadowRadiusY, 0, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.25)';
                ctx.fill();
                ctx.restore();

                // è»Šã®æç”»ï¼ˆä¸€åº¦ç™½ãã—ã¦ã€ãã®ä¸Šã‹ã‚‰ç€è‰²ã™ã‚‹ï¼‰

                // ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ã®æº–å‚™
                if (!window.carTintCanvas) {
                    window.carTintCanvas = document.createElement('canvas');
                    window.carTintCtx = window.carTintCanvas.getContext('2d');
                }

                // ã‚µã‚¤ã‚ºèª¿æ•´ï¼†ã‚¯ãƒªã‚¢
                if (window.carTintCanvas.width !== Math.ceil(carDisplayWidth) || window.carTintCanvas.height !== Math.ceil(carDisplayHeight)) {
                    window.carTintCanvas.width = Math.ceil(carDisplayWidth);
                    window.carTintCanvas.height = Math.ceil(carDisplayHeight);
                }
                const tCtx = window.carTintCtx;
                tCtx.clearRect(0, 0, window.carTintCanvas.width, window.carTintCanvas.height);

                // 1. è»Šã®ç”»åƒã‚’ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«æç”»
                tCtx.globalCompositeOperation = 'source-over';
                tCtx.drawImage(currentCarImg, 0, 0, carDisplayWidth, carDisplayHeight);

                // 2. ã€Œç™½åŒ–ã€å‡¦ç†ï¼ˆèµ¤ã‚’ç™½ã«ã™ã‚‹ï¼‰
                // lightenãªã©ã§ç™½ã‚’é‡ã­ã¦æ˜ã‚‹ãã—ã€saturationã§å½©åº¦ã‚’æŠœã
                tCtx.globalCompositeOperation = 'screen';
                tCtx.fillStyle = '#ffffff';
                tCtx.fillRect(0, 0, window.carTintCanvas.width, window.carTintCanvas.height);

                tCtx.globalCompositeOperation = 'saturation';
                tCtx.fillStyle = '#ffffff'; // ç™½ï¼ˆç„¡å½©è‰²ï¼‰
                tCtx.fillRect(0, 0, window.carTintCanvas.width, window.carTintCanvas.height);

                // 3. å…ƒã®è»Šã®å½¢ã§åˆ‡ã‚ŠæŠœãï¼ˆãƒã‚¹ã‚¯ï¼‰
                tCtx.globalCompositeOperation = 'destination-in';
                tCtx.drawImage(currentCarImg, 0, 0, carDisplayWidth, carDisplayHeight);

                // --- ã“ã‚Œã§ tintCanvas ã«ã¯ã€Œç™½ã„è»Šã€ãŒå…¥ã£ã¦ã„ã‚‹çŠ¶æ…‹ ---

                // 4. ã“ã“ã«ç€è‰²ã‚’è¡Œã†
                let targetColor = lastCollectedColor;
                if (!targetColor) targetColor = 'red'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèµ¤

                if (targetColor !== 'monochrome') {
                    // è‰²å®šç¾©
                    let overlayColor = 'rgba(255, 0, 50, 1.0)'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèµ¤ï¼ˆæ¿ƒã„ã‚ï¼‰
                    if (targetColor === 'blue') overlayColor = 'rgba(0, 100, 255, 1.0)';
                    else if (targetColor === 'green') overlayColor = 'rgba(0, 200, 50, 1.0)';
                    else if (targetColor === 'orange') overlayColor = 'rgba(255, 120, 0, 1.0)';
                    else if (targetColor === 'purple') overlayColor = 'rgba(150, 0, 200, 1.0)';
                    else if (targetColor === 'red') overlayColor = 'rgba(255, 0, 50, 1.0)';

                    // ç™½ã„è»Šã«è‰²ã‚’ä¹—ã›ã‚‹ (multiply + source-atop)
                    tCtx.globalCompositeOperation = 'multiply';
                    tCtx.fillStyle = overlayColor;
                    tCtx.fillRect(0, 0, window.carTintCanvas.width, window.carTintCanvas.height);

                    // ç™ºè‰²ã‚’è‰¯ãã™ã‚‹ãŸã‚ã«overlayã‚‚é‡ã­ã‚‹
                    tCtx.globalCompositeOperation = 'source-atop';
                    tCtx.fillStyle = overlayColor;

                    // ãƒã‚¹ã‚¯å†é©ç”¨
                    tCtx.globalCompositeOperation = 'destination-in';
                    tCtx.drawImage(currentCarImg, 0, 0, carDisplayWidth, carDisplayHeight);

                } else {
                    // ç™½ï¼ˆmonochromeï¼‰ã®å ´åˆï¼š
                    // ã™ã§ã«ç™½åŒ–å‡¦ç†æ¸ˆã¿ãªã®ã§ã€ä½•ã‚‚ã—ãªã‘ã‚Œã°ã€ŒçœŸã£ç™½ãªè»Šã€ã«ãªã‚‹ã€‚
                    // ãã®ã¾ã¾ã§OKã€‚
                }

                // 5. æœ€å¾Œã«ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ã¸æç”»
                ctx.drawImage(window.carTintCanvas, carX, carY, carDisplayWidth, carDisplayHeight);
                ctx.restore();
                return;
            }
        }

        let woOverlay = null; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨

        // --- æ›´æ–°ãƒ«ãƒ¼ãƒãƒ³ ---
        function update(dt) {
            // OPENING: ã‚ªãƒ¼ãƒˆãƒ©ãƒ³ï¼ˆå­—å¹•ç”¨ï¼‰
            if (gameState === 'opening') {
                speed = 400; // 30km/hç¨‹åº¦ã§èµ°è¡Œã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ 
                position = (position + speed * dt) % (segments.length * segmentLength);

                // å­—å¹•æ›´æ–°
                const elapsed = (Date.now() - gameStartTime) / 1000; // ç§’
                // duration(35s)ã«åˆã‚ã›ã¦å­—å¹•ã‚’å‡ºã™
                const totalDuration = 35;
                const timeProg = Math.min(1.0, elapsed / totalDuration);

                let textJP = "";
                let textEN = "";

                if (elapsed < 1.0) {
                    // é–‹å§‹1ç§’é–“ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
                    textEN = "";
                    textJP = "";
                } else if (elapsed < 4.0) {
                    textEN = "Textiles carry stories within them.";
                    textJP = "ç¹Šç¶­ã«ã¯ã€ç‰©èªãŒã‚ã‚Šã¾ã™ã€‚";
                } else if (elapsed < 11.0) {
                    textEN = "Some gain character through years of use,<br>while others are discarded, never knowing a human touch.";
                    textJP = "ä½•åº¦ã‚‚ä½¿ã‚ã‚Œã€å‘³ã‚ã„ã‚’å¸¯ã³ãŸç¹Šç¶­ã€‚<br>èª°ã«ã‚‚è§¦ã‚Œã‚‰ã‚Œãšã€å½¹ç›®ã‚’æœãŸã›ãªã„ã¾ã¾å»ƒæ£„ã•ã‚Œã‚‹ç¹Šç¶­ã€‚";
                } else if (elapsed < 15.0) {
                    textEN = "Inside every car, textiles live in silence.";
                    textJP = "è»Šã®ä¸­ã«ã‚‚ã€ã²ã£ãã‚Šã¨æ¯ã¥ãç¹Šç¶­ãŒã‚ã‚Šã¾ã™ã€‚";
                } else if (elapsed < 20.0) {
                    textEN = "Seats, floors, filters, and cushions.";
                    textJP = "ã‚·ãƒ¼ãƒˆã€ãƒ•ãƒ­ã‚¢ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€ã‚¯ãƒƒã‚·ãƒ§ãƒ³ã€‚";
                } else if (elapsed < 29.0) {
                    textEN = "We gently unearth their hidden narratives<br>to weave new possibilities for the future.";
                    textJP = "ç§ãŸã¡ã¯ã€ãã®ç‰©èªã‚’ä¸å¯§ã«ã™ãã„ä¸Šã’ã€<br>ç¹Šç¶­ãŒæŒã¤æ–°ãŸãªå¯èƒ½æ€§ã‚’ç´¡ã„ã§ã„ãã¾ã™ã€‚";
                } else {
                    textEN = "";
                    textJP = "";
                }

                if (textEN && textJP) {
                    caption.innerHTML = `<span style="font-family: 'DIN 2014', 'Barlow', sans-serif; font-size: 0.9em;">${textEN}</span><br><span style="font-family: 'Noto Sans JP', sans-serif; font-size: 0.8em; opacity: 0.9;">${textJP}</span>`;
                    caption.style.opacity = 1;
                } else {
                    caption.style.opacity = 0;
                }

                // Openingã§ã‚‚ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å‹•ã‹ã™
                const actualSpeed = speed * speedMultiplier * 1.8; // 18000 * 0.006 * 1.8 = 194.4km/h
                const jitter = (Math.random() - 0.5) * 0.2; // ã‚¸ãƒƒã‚¿ãƒ¼ã‚’å°‘ã—æ§ãˆã‚ã«
                if (speedValue) speedValue.textContent = (actualSpeed + jitter).toFixed(1);

                return;
            }

            // READY: æ¸›é€Ÿåœæ­¢
            if (gameState === 'ready') {
                caption.style.opacity = 0; // å­—å¹•æ¶ˆã™
                // ã‚ˆã‚Šè‡ªç„¶ãªãƒ–ãƒ¬ãƒ¼ã‚­ï¼šä¸€å®šã®æ¸›é€Ÿåº¦ã§0ã«å‘ã‹ã†
                if (speed > 0) {
                    speed -= 8; // æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ä¸€å®šé‡æ¸›é€Ÿ
                    if (speed < 0) speed = 0;
                }
                position = (position + speed * dt) % (segments.length * segmentLength);

                // ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å¾ã€…ã«0ã«ã™ã‚‹
                const actualSpeed = speed * speedMultiplier * 1.8;
                if (speedValue) speedValue.textContent = actualSpeed.toFixed(1);
                return;
            }

            // PLAYING: é€šå¸¸åˆ¶å¾¡
            if (gameState !== 'playing') return;

            // --- ãƒ‡ãƒ¼ã‚¿è¨ˆæ¸¬ ---
            playData.totalDistance += speed * speedMultiplier;
            const currentSteer = isMobile ? touchSteerDir : (keyLeft ? -1 : (keyRight ? 1 : 0));

            // ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°è¨ˆæ¸¬ã®æ”¹å–„ï¼ˆãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹ä»˜ãï¼‰
            const STEER_THRESHOLD = 0.2;

            // æ„å›³çš„ãªæ–¹å‘è»¢æ›ã®æ¤œçŸ¥
            if (Math.abs(currentSteer) > STEER_THRESHOLD) {
                if (playData.lastSignificantDir !== 0 && Math.sign(currentSteer) !== Math.sign(playData.lastSignificantDir)) {
                    playData.steeringFlipCount++;
                    playData.lastSignificantDir = currentSteer;
                } else if (playData.lastSignificantDir === 0) {
                    playData.lastSignificantDir = currentSteer;
                }
            }

            // è¿·ã„åº¦ï¼ˆWanderingï¼‰ã®è¨ˆæ¸¬: è›‡è¡Œã®ç·é‡
            if (speed > 100) {
                steeringInputSum += Math.abs(currentSteer);
            }

            lastSteerDir = currentSteer;
            if (Math.random() < 0.05) playData.speedHistory.push(speed);

            // å­—å¹•æ›´æ–°ï¼ˆPLAYINGä¸­ã¯éè¡¨ç¤ºï¼‰
            caption.style.opacity = 0;

            // é€Ÿåº¦UIæ›´æ–°
            const actualSpeed = speed * speedMultiplier * 1.8;
            speedValue.textContent = actualSpeed.toFixed(1);

            const elapsed = Date.now() - gameStartTime;

            // æ®‹ã‚Š3ç§’ã‹ã‚‰ãƒ›ãƒ¯ã‚¤ãƒˆã‚¢ã‚¦ãƒˆã¨ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
            const fadeStart = gameDuration - 2000;
            if (elapsed > fadeStart) {
                const fadeProg = Math.min(1.0, (elapsed - fadeStart) / 2000);

                // 1. ãƒ›ãƒ¯ã‚¤ãƒˆã‚¢ã‚¦ãƒˆ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨)
                if (!woOverlay) woOverlay = document.getElementById('whiteout-overlay');
                if (woOverlay) woOverlay.style.opacity = fadeProg;

                // 2. éŸ³é‡ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
                if (window.bgm) window.bgm.volume = 0.5 * (1 - fadeProg);
                if (window.motor) window.motor.volume = 0.6 * (1 - fadeProg);
            }

            if (elapsed > gameDuration && !gameEnded) {
                endGame();
            }
        }

        let lastTime = 0;

        // --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ---
        function loop() {
            if (gameState === 'start') {
                lastTime = Date.now();
                requestAnimationFrame(loop);
                return;
            }

            const now = Date.now();
            // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ è¨ˆç®— (æœ€å¤§0.1ç§’ã§ã‚­ãƒ£ãƒƒãƒ—ã—ã¦é£›ã³é£›ã³é˜²ã)
            const dt = Math.min((now - lastTime) / 1000, 0.1);
            lastTime = now;

            // å…±é€šæ›´æ–°å‡¦ç†
            update(dt);

            if (gameState === 'playing') {
                const elapsed = Date.now() - gameStartTime;
                if (elapsed > gameDuration && !gameEnded) {
                    endGame();
                    requestAnimationFrame(loop);
                    return;
                }

                // ã‚°ãƒªãƒƒãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆè¡çªæ™‚ï¼‰
                if (window.glitchIntensity > 0) {
                    const intensity = window.glitchIntensity;

                    // 1. ç”»é¢ã®ãšã‚Œï¼ˆRGBåˆ†é›¢é¢¨ï¼‰
                    ctx.save();
                    ctx.globalCompositeOperation = 'screen';
                    ctx.fillStyle = `rgba(255, 255, 255, ${0.5 * intensity})`;
                    ctx.fillRect(0, 0, width, height);

                    for (let i = 0; i < 5 + 10 * intensity; i++) {
                        const h = Math.random() * 50 * intensity;
                        const y = Math.random() * height;
                        const dx = (Math.random() - 0.5) * 40 * intensity;
                        ctx.drawImage(canvas, 0, y, width, h, dx, y, width, h);
                    }
                    ctx.restore();

                    // æ¸›è¡°
                    window.glitchIntensity *= 0.85;
                    if (window.glitchIntensity < 0.01) window.glitchIntensity = 0;
                }

                const dtScale = dt * 60; // 60FPSåŸºæº–ã®ã‚¹ã‚±ãƒ¼ãƒ«ä¿‚æ•°

                if (isMobile) {
                    // MobileåŠ é€Ÿãƒ–ãƒ¼ã‚¹ãƒˆå‰Šé™¤ï¼ˆåŸºæœ¬é€Ÿåº¦ã‚’ä¸Šã’ãŸãŸã‚ï¼‰
                    speed += accel * dtScale;
                } else {
                    if (keyFaster) speed += accel * dtScale; else speed += decel * dtScale;
                }

                const currentSeg = segments[Math.floor(position / segmentLength) % segments.length];
                const curveForce = currentSeg.curve * (speed / maxSpeed) * 0.000005 * dtScale;
                playerX += curveForce;

                const steerSpeed = isMobile ? 0.04 : 0.015; // ãƒãƒ³ãƒ‰ãƒ«æ„Ÿåº¦ (1.5å€)
                let steerDir = 0;
                if (isMobile) {
                    steerDir = touchSteerDir;
                } else {
                    steerDir = (keyRight ? 1 : 0) + (keyLeft ? -1 : 0);
                }
                if (steerDir !== 0) {
                    playerX += steerDir * steerSpeed * dtScale;
                }

                // ãƒ‡ãƒ¼ã‚¿åé›†
                lastPlayerX = playerX;

                // ã‚³ãƒ¼ã‚¹ã‚¢ã‚¦ãƒˆåˆ¤å®š
                if ((playerX < -1 || playerX > 1) && speed > offRoadLimit) {
                    speed += offRoadDecel * dtScale;
                    playData.collisionCount += 0.05 * dtScale;
                }

                playerX = Math.max(-2, Math.min(2, playerX));
                speed = Math.max(0, Math.min(maxSpeed, speed));

                // speedMultiplierã¯å®šæ•°(0.006)ãªã®ã§ã€ã“ã‚Œã«dtScaleã‚’æ›ã‘ã‚‹ã“ã¨ã§ç§»å‹•é‡ã‚’å®Ÿæ™‚é–“ä¾å­˜ã«ã™ã‚‹
                position += speed * speedMultiplier * dtScale;
                while (position >= totalSegments * segmentLength) position -= totalSegments * segmentLength;
                while (position < 0) position += totalSegments * segmentLength;
            }

            // æç”» (Playing, Opening, Ready)
            if (gameState === 'playing' || gameState === 'opening' || gameState === 'ready') {
                render();
            }

            if (!gameEnded) {
                requestAnimationFrame(loop);
            }
        }

        // --- çµ‚äº†å‡¦ç† ---
        function endGame() {
            if (gameEnded) return;
            gameEnded = true;
            gameState = 'result';

            if (window.bgm) { window.bgm.pause(); window.bgm.currentTime = 0; }
            if (window.motor) { window.motor.pause(); window.motor.currentTime = 0; }
            if (window.narration) { window.narration.pause(); }

            document.getElementById('ui-layer').style.display = 'none';
            document.getElementById('speedometer').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('scanlines').style.display = 'none';

            // ãƒ›ãƒ¯ã‚¤ãƒˆã‚¢ã‚¦ãƒˆè§£é™¤
            const wo = document.getElementById('whiteout-overlay');
            if (wo) {
                wo.style.opacity = '0';
                setTimeout(() => wo.style.display = 'none', 500); // ãƒ•ã‚§ãƒ¼ãƒ‰å¾Œã«æ¶ˆã™
            }

            const resScreen = document.getElementById('result-screen');
            resScreen.classList.add('active');

            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ
            // ---------------------------------------------------
            // 1. è‰²ã®é›†è¨ˆã¨æ±ºå®š (Color Logic)
            // ---------------------------------------------------
            const sortedColors = Object.entries(playData.itemCounts)
                .sort((a, b) => b[1] - a[1]) // å›æ•°ãŒå¤šã„é †
                .filter(entry => entry[1] > 0)
                .map(entry => entry[0]);

            // ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼: æœ€ã‚‚å¤šãå–ã£ãŸè‰²ï¼ˆãªã‘ã‚Œã°æœ€å¾Œã«å–ã£ãŸè‰²ã€ãã‚Œã‚‚ãªã‘ã‚Œã°ãƒ¢ãƒã‚¯ãƒ­ï¼‰
            // â€»ã€Œæœ€å¾Œã«å–ã£ãŸè‰²ã€ã‚ˆã‚Šã€Œå¤šãå–ã£ãŸè‰²ã€ã®æ–¹ãŒã€ŒåŸ·ç€ã€ã‚’è¡¨ã™ãŸã‚
            let mainColor = sortedColors[0] || lastCollectedColor || 'monochrome';

            // VIPç”¨ã‚µãƒ–ã‚«ãƒ©ãƒ¼
            let subColor = sortedColors[1] || mainColor;

            // çµæœç”»é¢ã§ã®è¡¨ç¤ºç”¨ã«ä¿å­˜
            const selectedPalette = mainColor;

            // ---------------------------------------------------
            // 2. ã‚¹ã‚³ã‚¢ç®—å‡º (Score Logic)
            // ---------------------------------------------------

            // G (Greed): åŸ·ç€åº¦ (ã‚¢ã‚¤ãƒ†ãƒ å–å¾—æ•°)
            // 0ã€œ10å€‹ã§åˆ¤å®šã€‚å¤šã™ãã‚‹ã¨çœŸã£é»’ã«ãªã‚‹ã®ã§MAX10ç¨‹åº¦ã§æ­£è¦åŒ–
            const totalItems = Object.values(playData.itemCounts).reduce((a, b) => a + b, 0);
            const greedScore = Math.min(1.0, totalItems / 10);

            // S (Steer): è¿·ã„åº¦ (åˆ‡ã‚Šè¿”ã—å›æ•°é‡è¦–)
            // Flipå›æ•°: æ„å›³çš„ãªåˆ‡ã‚Šè¿”ã—ã€‚20å›ä»¥ä¸Šã§ã€Œè¿·ã„ã€ã¨ã¿ãªã™ã‚ˆã†ç·©å’Œ
            const flipScore = Math.min(1.0, playData.steeringFlipCount / 24);
            // Wander: å…¥åŠ›ç·é‡ã€‚ã‚ãã¾ã§è£œåŠ©çš„ï¼ˆã‚«ãƒ¼ãƒ–å¯¾å¿œåˆ†ã‚‚å«ã‚€ãŸã‚ï¼‰
            const avgSteeringInput = steeringInputSum / (playData.speedHistory.length || 1);
            const wanderScore = Math.min(1.0, avgSteeringInput * 2.0);

            // è¿·ã„åº¦ = åˆ‡ã‚Šè¿”ã—(80%) + è›‡è¡Œé‡(20%)
            const steerScore = (flipScore * 0.9) + (wanderScore * 0.1);

            // R (Risk): ãƒªã‚¹ã‚¯è¨±å®¹åº¦ (è¡çªæ•°)
            // 0å›=0.0, 5å›ä»¥ä¸Š=1.0
            const crashScore = Math.min(1.0, playData.collisionCount * 0.2);

            // Speed: å¹³å‡é€Ÿåº¦ (å‚è€ƒå€¤ã¨ã—ã¦ç®—å‡ºã™ã‚‹ãŒã€ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¸ã®å½±éŸ¿ã¯ä¸‹ã’ã‚‹)
            const avgSpeed = playData.speedHistory.reduce((a, b) => a + b, 0) / (playData.speedHistory.length || 1);
            // const speedScore = Math.min(1.0, avgSpeed / maxSpeed); // å»ƒæ­¢

            // ---------------------------------------------------
            // 3. ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (Generation Params)
            // ---------------------------------------------------
            const seed = Math.random();

            // Amp (æŒ¯å¹…): Så€¤ï¼ˆè¿·ã„ï¼‰ãŒãã®ã¾ã¾æ³¢ã®å¤§ãã•ã«
            const warpAmpBase = 0.05 + steerScore * 0.5; // 0.05 ~ 0.55
            const warpAmpRand = (seed * 0.2) - 0.1;
            const finalWarpAmp = Math.max(0.02, warpAmpBase + warpAmpRand);

            // Freq (å‘¨æ³¢æ•°): Så€¤ãŒé«˜ã„ï¼ç´°ã‹ãéœ‡ãˆã‚‹
            const warpFreqBase = 0.1 + steerScore * 0.6;
            const warpFreqRand = (Math.random() * 0.4) - 0.2;
            const finalWarpFreq = Math.max(0.1, warpFreqBase + warpFreqRand);

            // Density (å¯†åº¦): Greedï¼ˆåŸ·ç€ï¼‰ãŒé«˜ã„ã»ã©å¯†åº¦ãŒé«˜ããªã‚‹
            // æ¬²æ·±ã„ï¼ç›®ãŒè©°ã¾ã£ã¦ã„ã‚‹
            const densityBase = 0.2 + greedScore * 0.6; // 0.2 ~ 0.8
            const finalDensity = Math.min(0.9, densityBase + (Math.random() * 0.1));

            // Style: Rå€¤ï¼ˆãƒªã‚¹ã‚¯ï¼‰ã¨Så€¤ï¼ˆè¿·ã„ï¼‰ã§æ±ºå®š
            let styleType = 'classic';
            if (crashScore > 0.5) {
                styleType = 'glitch'; // å‚·ã ã‚‰ã‘
            } else if (steerScore > 0.5) {
                styleType = 'organic'; // è¿·ã„ãŒå¤šã„ï¼æœ‰æ©Ÿçš„
            } else {
                // ãƒ©ãƒ³ãƒ€ãƒ ã§å°‘ã—æ··ãœã‚‹
                if (Math.random() < 0.3) styleType = 'organic';
            }

            const genParams = {
                paletteId: mainColor,
                warpAmp: finalWarpAmp,
                warpFreq: finalWarpFreq,
                density: finalDensity,
                noise: crashScore * 0.6 + (styleType === 'glitch' ? 0.3 : 0),
                style: styleType
            };

            // ---------------------------------------------------
            // 4. è¨ºæ–­ç”¨ãƒ‡ãƒ¼ã‚¿ (Diagnosis Data)
            // ---------------------------------------------------
            const diagnosisParams = {
                steeringHesitation: playData.steeringFlipCount,
                riskTolerance: playData.collisionCount,
                itemGreediness: {
                    total: totalItems,
                    details: playData.itemCounts
                },
                colorPreference: mainColor, // ã“ã“ã‚‚Top1ã‚’ä½¿ç”¨
                baseMetrics: {
                    avgSpeed: avgSpeed,
                    steerScore: steerScore,
                    crashScore: crashScore
                }
            };

            // ç›¸æ€§è¨ºæ–­ã®æº–å‚™
            if (window.isVip) {
                diagnosisParams.compatibility = {
                    partnerWarp: genParams,
                    myWeft: genParams
                };
            } else if (window.isWeftMode && window.warpDataFromUrl) {
                diagnosisParams.compatibility = {
                    partnerWarp: window.warpDataFromUrl,
                    myWeft: genParams
                };
            }

            console.log("Diagnosis Data:", diagnosisParams);

            // ---------------------------------------------------
            // 5. ãƒ†ã‚­ã‚¹ã‚¿ã‚¤ãƒ«ç”Ÿæˆå®Ÿè¡Œ
            // ---------------------------------------------------
            let dataUrl;
            if (window.isVip) {
                // VIP: Top1è‰² x Top2è‰²
                console.log(`VIP Weaving: ${mainColor} x ${subColor}`);

                // çµŒç³¸ (Main)
                const warpP = JSON.parse(JSON.stringify(genParams));
                warpP.paletteId = mainColor;

                // ç·¯ç³¸ (Sub)
                const weftP = JSON.parse(JSON.stringify(genParams));
                weftP.paletteId = subColor;

                dataUrl = generateTextile(warpP, weftP);
            } else if (window.isWeftMode && window.warpDataFromUrl) {
                dataUrl = generateTextile(window.warpDataFromUrl, genParams);
            } else {
                dataUrl = generateTextile(genParams, null);
            }

            const imgEl = document.getElementById('material-image');
            imgEl.src = dataUrl;
            imgEl.onload = () => {
                document.getElementById('loading-text').style.display = 'none';
                imgEl.style.display = 'block';

                // çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ (New)
                generateAnalysisReport(diagnosisParams, result);
                document.getElementById('analysis-report').style.display = 'block';
                document.getElementById('material-id').style.display = 'block';
                document.getElementById('reserve-btn').style.display = 'block';
                document.getElementById('calendar-btn').style.display = 'block';

                // ã‚³ãƒ©ãƒœã‚¨ãƒªã‚¢è¡¨ç¤ºåˆ¶å¾¡
                const collabSection = document.getElementById('collab-section');
                collabSection.style.display = 'block';

                // å…¨ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¸€æ—¦éš ã™
                document.getElementById('warp-mode-actions').style.display = 'none';
                document.getElementById('weft-mode-result').style.display = 'none';
                document.getElementById('vip-mode-result').style.display = 'none';

                if (window.isVip) {
                    // C. VIPãƒ¢ãƒ¼ãƒ‰
                    document.getElementById('vip-mode-result').style.display = 'block';

                    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã®æ›´æ–° (ã‚»ãƒ¬ã‚¯ã‚¿ä¿®æ­£)
                    const titleEl = document.querySelector('#result-screen .header');
                    if (titleEl) titleEl.innerHTML = `OFFICIAL TICKET`;

                    // ãƒã‚±ãƒƒãƒˆãƒ›ãƒ«ãƒ€ãƒ¼æƒ…å ±ã®è¿½åŠ 
                    const holderArea = document.getElementById('vip-ticket-holder');
                    const nameEl = document.getElementById('vip-holder-name');
                    if (holderArea && nameEl && window.vipData) {
                        nameEl.innerText = window.vipData.name;
                        holderArea.style.display = 'block';
                    }
                } else if (window.isWeftMode && window.warpDataFromUrl) {
                    // B. ç·¯ç³¸ãƒ¢ãƒ¼ãƒ‰ (ã‚³ãƒ©ãƒœå®Œäº†)
                    document.getElementById('weft-mode-result').style.display = 'block';
                } else {
                    // A. çµŒç³¸ãƒ¢ãƒ¼ãƒ‰ (ä¸€èˆ¬å®¢ â†’ æ‹›å¾…ã¸)
                    document.getElementById('warp-mode-actions').style.display = 'block';
                }
            };

            const date = new Date();
            const idStr = `MAT-${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}-${Math.floor(Math.random() * 9999)}`;
            document.getElementById('material-id').innerText = idStr;

            // --- ç¹Šç¶­ã‚¿ã‚¤ãƒ—è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯ (Ver 2.0) ---
            const steer = playData.steeringFlipCount;
            const risk = playData.collisionCount;
            const greed = Object.values(playData.itemCounts).reduce((a, b) => a + b, 0);

            let result = { id: 15, nameEn: "UNKNOWN MATERIAL", nameJp: "æœªè§£æã®ãƒãƒ†ãƒªã‚¢ãƒ«", desc: "è§£æä¸èƒ½ã€‚æ—¢å­˜ã®ç¹Šç¶­ãƒ‡ãƒ¼ã‚¿ã«è©²å½“ã—ãªã„ã€ç‰¹ç•°ç‚¹ï¼ˆã‚·ãƒ³ã‚®ãƒ¥ãƒ©ãƒªãƒ†ã‚£ï¼‰ã€‚" };

            // 1. ç‰¹æ®Šæ  (å„ªå…ˆåº¦é«˜)
            if (steer < 7 && risk < 1.1 && greed < 4) {
                result = { id: 1, nameEn: "GHOST ORGANZA", nameJp: "å¹½éœŠã®ã‚ªãƒ¼ã‚¬ãƒ³ã‚¸ãƒ¼", desc: "å­˜åœ¨æ„ŸãŒå¸Œè–„ã§ã€é€æ˜ã«è¿‘ã„ã€‚ä¸–ç•Œã«å¹²æ¸‰ã™ã‚‹ã“ã¨ã‚’æ‹’ã‚“ã ã€å„šã„ç¹Šç¶­ã€‚" };
            } else if (risk < 1.1 && greed >= 9) {
                result = { id: 2, nameEn: "ARMORED KEVLAR", nameJp: "æ­¦è£…ã™ã‚‹ã‚±ãƒ–ãƒ©ãƒ¼", desc: "åœ§å€’çš„ãªé˜²å¾¡åŠ›ã¨è²ªæ¬²ã•ã€‚å‚·ä¸€ã¤è² ã‚ãšã«å…¨ã¦ã‚’æ‰‹ã«å…¥ã‚Œã‚‹ã€æœ€å¼·ã®åˆæˆç¹Šç¶­ã€‚" };
            } else if (risk >= 8) {
                result = { id: 3, nameEn: "BURNT VINYL", nameJp: "ç„¦ã’ãŸãƒ“ãƒ‹ãƒ¼ãƒ«", desc: "æ‘©æ“¦ç†±ã§æº¶ã‘å‡ºã—ã€ç•°è‡­ã‚’æ”¾ã¤ã€‚ç—›ã¿ã‚’ç‡ƒæ–™ã«ã—ã¦èµ°ã‚‹ã€å±é™ºãªç‰©è³ªã€‚" };
            } else if (steer >= 40) {
                result = { id: 4, nameEn: "NEURAL FIBER", nameJp: "ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒ»ãƒ•ã‚¡ã‚¤ãƒãƒ¼", desc: "è¤‡é›‘ã«çµ¡ã¿åˆã†æ€è€ƒã®è¿·è·¯ã€‚ç¹Šç´°ã™ãã¦ã€èª°ã«ã‚‚è§£ãã“ã¨ãŒã§ããªã„è„³å†…ç¹Šç¶­ã€‚" };
            }
            // 2. é€šå¸¸æ 
            else {
                if (risk < 1.1) { // Risk: Low
                    if (steer < 7) result = { id: 5, nameEn: "PURE SILK", nameJp: "ç´”ç™½ã®ã‚·ãƒ«ã‚¯", desc: "è¿·ã„ã®ãªã„ä¸€ç›´ç·šã®ç¾ã—ã•ã€‚é«˜è²´ã ãŒã€æ±šã‚Œã‚’çŸ¥ã‚‰ãªã„ãŸã‚æŸ“ã¾ã‚Šã‚„ã™ã„ã€‚" };
                    else if (greed >= 9) result = { id: 6, nameEn: "HOLOGRAPHIC FILM", nameJp: "åå…‰ãƒ•ã‚£ãƒ«ãƒ ", desc: "æºã‚Œå‹•ããŸã³ã«è‰²ã‚’å¤‰ãˆã‚‹ã€‚å¤šé¢çš„ã§æ´ã¿ã©ã“ã‚ãŒãªã„ã€ç¾ä»£çš„ãªè¼ãã€‚" };
                    else result = { id: 7, nameEn: "GLASS FIBER", nameJp: "ã‚°ãƒ©ã‚¹ãƒ•ã‚¡ã‚¤ãƒãƒ¼", desc: "ç¹Šç´°ã§æŠ˜ã‚Œã‚„ã™ã„ãŒã€é‹­ã„é€éæ€§ã‚’æŒã¤ã€‚è§¦ã‚Œã‚‹è€…ã‚’å‚·ã¤ã‘ã‚‹ã‚¬ãƒ©ã‚¹ã®ç³¸ã€‚" };
                } else if (risk < 5) { // Risk: Mid (1.1 - 4.9)
                    if (steer < 7) {
                        if (greed >= 9) result = { id: 9, nameEn: "CLASSIC TWEED", nameJp: "ä¼çµ±çš„ãªãƒ„ã‚¤ãƒ¼ãƒ‰", desc: "å¤šãã®è‰²ï¼ˆæ¬²æœ›ï¼‰ã‚’æ•´ç„¶ã¨ç¹”ã‚Šè¾¼ã‚“ã ã€çŸ¥çš„ã§ãƒˆãƒ©ãƒ‡ã‚£ã‚·ãƒ§ãƒŠãƒ«ãªåšã¿ã€‚" };
                        else result = { id: 8, nameEn: "HEAVY CANVAS", nameJp: "é ‘ä¸ˆãªå¸†å¸ƒ", desc: "è³ªå®Ÿå‰›å¥ã€‚é¢ç™½ã¿ã«ã¯æ¬ ã‘ã‚‹ãŒã€æœ€ã‚‚ä¿¡é ¼ã§ãã€ä½•ã«ã§ã‚‚ãªã‚Œã‚‹ç´ æã€‚" };
                    } else {
                        if (greed >= 9) result = { id: 11, nameEn: "ACTIVE MESH", nameJp: "èºå‹•ã™ã‚‹ãƒ¡ãƒƒã‚·ãƒ¥", desc: "é€šæ°—æ€§ã¨ä¼¸ç¸®æ€§ãŒæŠœç¾¤ã€‚ã˜ã£ã¨ã—ã¦ã„ã‚‰ã‚Œãªã„ã€ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®å¡Šã€‚" };
                        else result = { id: 10, nameEn: "MEDICAL GAUZE", nameJp: "ç™’ã‚„ã—ã®ã‚¬ãƒ¼ã‚¼", desc: "æŸ”ã‚‰ã‹ãã€å„ªã—ãåŒ…ã¿è¾¼ã‚€ã€‚è¿·ã„å‚·ã¤ã„ãŸçµŒé¨“ãŒã€ä»–è€…ã¸ã®å„ªã—ã•ã«ãªã‚‹ã€‚" };
                    }
                } else { // Risk: High (5+)
                    if (steer < 7) result = { id: 12, nameEn: "VINTAGE DENIM", nameJp: "ãƒ´ã‚£ãƒ³ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ‹ãƒ ", desc: "å‚·ã¤ãã»ã©ã«å‘³ãŒå‡ºã‚‹ã€‚ä¸å™¨ç”¨ãªç”Ÿãæ–¹ãŒãã®ã¾ã¾ãƒ†ã‚¯ã‚¹ãƒãƒ£ã«ãªã£ãŸã€ä¸æœ½ã®å®šç•ªã€‚" };
                    else if (greed >= 9) result = { id: 13, nameEn: "GLITCH NYLON", nameJp: "ã‚°ãƒªãƒƒãƒãƒŠã‚¤ãƒ­ãƒ³", desc: "ãƒã‚¤ã‚ºã¨è›å…‰è‰²ãŒæ··ã–ã‚Šåˆã†ã€‚ã‚«ã‚ªã‚¹ã‚’æ„›ã™ã‚‹ã€ãƒ‡ã‚¸ã‚¿ãƒ«ä¸–ä»£ã®ãƒ‘ãƒ³ã‚¯ç´ æã€‚" };
                    else result = { id: 14, nameEn: "BORO PATCHWORK", nameJp: "ç¶™ãæ¥ãã®ãƒœãƒ­", desc: "æ‹¾ã„é›†ã‚ãŸæ–­ç‰‡ã‚’ç¸«ã„åˆã‚ã›ãŸè¨˜æ†¶ã®å¸ƒã€‚è²§ã—ã„ã®ã§ã¯ãªãã€æ­´å²ãŒæ·±ã„ã€‚" };
                }
            }

            // è¡¨ç¤ºæ›´æ–°
            // const styleName = genParams.style.toUpperCase();
            // const dens = Math.floor(genParams.density * 100);

            // æ—§è¨ºæ–­è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯å‰Šé™¤ (Combined Reportã«çµ±åˆæ¸ˆã¿)

            // genParamsã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆæ‹›å¾…ãƒªãƒ³ã‚¯ç”Ÿæˆç”¨ï¼‰
            window.currentWarpData = genParams;
            window.diagnosisResults = result; // çµæœã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¿å­˜
            window.diagnosisParams = diagnosisParams; // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´°ã‚‚ä¿å­˜

            // --- ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ (Persistence) ---
            const finalKey = getStorageKey();

            let currentMode = 'warp';
            if (window.isVip) currentMode = 'vip';
            else if (window.isWeftMode) currentMode = 'weft';

            const saveData = {
                genParams: genParams,
                diagnosisResults: result,
                diagnosisParams: diagnosisParams, // è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”¨ã«è¿½åŠ 
                vipData: window.vipData,
                vipColors: window.isVip ? { main: mainColor, sub: subColor } : null,
                playMode: currentMode, // å¾©å…ƒåˆ¤å®šç”¨ãƒ¢ãƒ¼ãƒ‰
                timestamp: Date.now()
            };
            localStorage.setItem(finalKey, JSON.stringify(saveData));
        }



        // --- è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯é–¢æ•° (Extracted) ---
        function calculateDiagnosis(data, color) {
            const steer = data.steeringFlipCount;
            const risk = data.collisionCount;
            const greed = Object.values(data.itemCounts).reduce((a, b) => a + b, 0);

            let result = { id: 15, nameEn: "UNKNOWN MATERIAL", nameJp: "æœªè§£æã®ãƒãƒ†ãƒªã‚¢ãƒ«", desc: "è§£æä¸èƒ½ã€‚æ—¢å­˜ã®ç¹Šç¶­ãƒ‡ãƒ¼ã‚¿ã«è©²å½“ã—ãªã„ã€ç‰¹ç•°ç‚¹ï¼ˆã‚·ãƒ³ã‚®ãƒ¥ãƒ©ãƒªãƒ†ã‚£ï¼‰ã€‚" };

            // 1. ç‰¹æ®Šæ  (å„ªå…ˆåº¦é«˜)
            if (steer < 7 && risk < 1.1 && greed < 4) {
                result = { id: 1, nameEn: "GHOST ORGANZA", nameJp: "å¹½éœŠã®ã‚ªãƒ¼ã‚¬ãƒ³ã‚¸ãƒ¼", desc: "å­˜åœ¨æ„ŸãŒå¸Œè–„ã§ã€é€æ˜ã«è¿‘ã„ã€‚ä¸–ç•Œã«å¹²æ¸‰ã™ã‚‹ã“ã¨ã‚’æ‹’ã‚“ã ã€å„šã„ç¹Šç¶­ã€‚" };
            } else if (risk < 1.1 && greed >= 9) {
                result = { id: 2, nameEn: "ARMORED KEVLAR", nameJp: "æ­¦è£…ã™ã‚‹ã‚±ãƒ–ãƒ©ãƒ¼", desc: "åœ§å€’çš„ãªé˜²å¾¡åŠ›ã¨è²ªæ¬²ã•ã€‚å‚·ä¸€ã¤è² ã‚ãšã«å…¨ã¦ã‚’æ‰‹ã«å…¥ã‚Œã‚‹ã€æœ€å¼·ã®åˆæˆç¹Šç¶­ã€‚" };
            } else if (risk >= 8) {
                result = { id: 3, nameEn: "BURNT VINYL", nameJp: "ç„¦ã’ãŸãƒ“ãƒ‹ãƒ¼ãƒ«", desc: "æ‘©æ“¦ç†±ã§æº¶ã‘å‡ºã—ã€ç•°è‡­ã‚’æ”¾ã¤ã€‚ç—›ã¿ã‚’ç‡ƒæ–™ã«ã—ã¦èµ°ã‚‹ã€å±é™ºãªç‰©è³ªã€‚" };
            } else if (steer >= 20) {
                result = { id: 4, nameEn: "NEURAL FIBER", nameJp: "ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒ»ãƒ•ã‚¡ã‚¤ãƒãƒ¼", desc: "è¤‡é›‘ã«çµ¡ã¿åˆã†æ€è€ƒã®è¿·è·¯ã€‚ç¹Šç´°ã™ãã¦ã€èª°ã«ã‚‚è§£ãã“ã¨ãŒã§ããªã„è„³å†…ç¹Šç¶­ã€‚" };
            }
            // 2. é€šå¸¸æ 
            else {
                if (risk < 1.1) { // Risk: Low
                    if (steer < 7) result = { id: 5, nameEn: "PURE SILK", nameJp: "ç´”ç™½ã®ã‚·ãƒ«ã‚¯", desc: "è¿·ã„ã®ãªã„ä¸€ç›´ç·šã®ç¾ã—ã•ã€‚é«˜è²´ã ãŒã€æ±šã‚Œã‚’çŸ¥ã‚‰ãªã„ãŸã‚æŸ“ã¾ã‚Šã‚„ã™ã„ã€‚" };
                    else if (greed >= 9) result = { id: 6, nameEn: "HOLOGRAPHIC FILM", nameJp: "åå…‰ãƒ•ã‚£ãƒ«ãƒ ", desc: "æºã‚Œå‹•ããŸã³ã«è‰²ã‚’å¤‰ãˆã‚‹ã€‚å¤šé¢çš„ã§æ´ã¿ã©ã“ã‚ãŒãªã„ã€ç¾ä»£çš„ãªè¼ãã€‚" };
                    else result = { id: 7, nameEn: "GLASS FIBER", nameJp: "ã‚°ãƒ©ã‚¹ãƒ•ã‚¡ã‚¤ãƒãƒ¼", desc: "ç¹Šç´°ã§æŠ˜ã‚Œã‚„ã™ã„ãŒã€é‹­ã„é€éæ€§ã‚’æŒã¤ã€‚è§¦ã‚Œã‚‹è€…ã‚’å‚·ã¤ã‘ã‚‹ã‚¬ãƒ©ã‚¹ã®ç³¸ã€‚" };
                } else if (risk < 5) { // Risk: Mid (1.1 - 4.9)
                    if (steer < 7) {
                        if (greed >= 9) result = { id: 9, nameEn: "CLASSIC TWEED", nameJp: "ä¼çµ±çš„ãªãƒ„ã‚¤ãƒ¼ãƒ‰", desc: "å¤šãã®è‰²ï¼ˆæ¬²æœ›ï¼‰ã‚’æ•´ç„¶ã¨ç¹”ã‚Šè¾¼ã‚“ã ã€çŸ¥çš„ã§ãƒˆãƒ©ãƒ‡ã‚£ã‚·ãƒ§ãƒŠãƒ«ãªåšã¿ã€‚" };
                        else result = { id: 8, nameEn: "HEAVY CANVAS", nameJp: "é ‘ä¸ˆãªå¸†å¸ƒ", desc: "è³ªå®Ÿå‰›å¥ã€‚é¢ç™½ã¿ã«ã¯æ¬ ã‘ã‚‹ãŒã€æœ€ã‚‚ä¿¡é ¼ã§ãã€ä½•ã«ã§ã‚‚ãªã‚Œã‚‹ç´ æã€‚" };
                    } else {
                        if (greed >= 9) result = { id: 11, nameEn: "ACTIVE MESH", nameJp: "èºå‹•ã™ã‚‹ãƒ¡ãƒƒã‚·ãƒ¥", desc: "é€šæ°—æ€§ã¨ä¼¸ç¸®æ€§ãŒæŠœç¾¤ã€‚ã˜ã£ã¨ã—ã¦ã„ã‚‰ã‚Œãªã„ã€ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®å¡Šã€‚" };
                        else result = { id: 10, nameEn: "MEDICAL GAUZE", nameJp: "ç™’ã‚„ã—ã®ã‚¬ãƒ¼ã‚¼", desc: "æŸ”ã‚‰ã‹ãã€å„ªã—ãåŒ…ã¿è¾¼ã‚€ã€‚è¿·ã„å‚·ã¤ã„ãŸçµŒé¨“ãŒã€ä»–è€…ã¸ã®å„ªã—ã•ã«ãªã‚‹ã€‚" };
                    }
                } else { // Risk: High (5+)
                    if (steer < 7) result = { id: 12, nameEn: "VINTAGE DENIM", nameJp: "ãƒ´ã‚£ãƒ³ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ‹ãƒ ", desc: "å‚·ã¤ãã»ã©ã«å‘³ãŒå‡ºã‚‹ã€‚ä¸å™¨ç”¨ãªç”Ÿãæ–¹ãŒãã®ã¾ã¾ãƒ†ã‚¯ã‚¹ãƒãƒ£ã«ãªã£ãŸã€ä¸æœ½ã®å®šç•ªã€‚" };
                    else if (greed >= 9) result = { id: 13, nameEn: "GLITCH NYLON", nameJp: "ã‚°ãƒªãƒƒãƒãƒŠã‚¤ãƒ­ãƒ³", desc: "ãƒã‚¤ã‚ºã¨è›å…‰è‰²ãŒæ··ã–ã‚Šåˆã†ã€‚ã‚«ã‚ªã‚¹ã‚’æ„›ã™ã‚‹ã€ãƒ‡ã‚¸ã‚¿ãƒ«ä¸–ä»£ã®ãƒ‘ãƒ³ã‚¯ç´ æã€‚" };
                    else result = { id: 14, nameEn: "BORO PATCHWORK", nameJp: "ç¶™ãæ¥ãã®ãƒœãƒ­", desc: "æ‹¾ã„é›†ã‚ãŸæ–­ç‰‡ã‚’ç¸«ã„åˆã‚ã›ãŸè¨˜æ†¶ã®å¸ƒã€‚è²§ã—ã„ã®ã§ã¯ãªãã€æ­´å²ãŒæ·±ã„ã€‚" };
                }
            }
            return result;
        }



        // --- ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (Integrated Text Report) ---
        function generateAnalysisReport(params, resultData) {
            const reportDiv = document.getElementById('analysis-report');
            if (!reportDiv) return;

            const sScore = params.baseMetrics.steerScore;
            const rScore = params.baseMetrics.crashScore;
            const gTotal = params.itemGreediness.total;
            const mainColor = params.colorPreference.toUpperCase();

            // æ–‡è„ˆåˆ¤å®š (Context) - ã‚·ãƒ³ãƒ—ãƒ«ã«å½¹å‰²ã®ã¿å®šç¾©
            let subject = "çµŒç³¸ï¼ˆã‚¿ãƒ†ã‚¤ãƒˆï¼‰";
            let product = "ãƒãƒ†ãƒªã‚¢ãƒ«";
            let compatibilityText = "";

            if (window.isVip) {
                subject = "å¸ƒï¼ˆãƒ†ã‚­ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰";
                product = "ã“ã®ä¸€æš";
                compatibilityText = `YOUR OWN WEAVING`;
            } else if (window.isWeftMode && window.warpDataFromUrl) {
                subject = "ç·¯ç³¸ï¼ˆãƒ¨ã‚³ã‚¤ãƒˆï¼‰";
                product = "ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³";
                compatibilityText = `COLLABORATION: HOST & YOU`;
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆçµŒç³¸ã®ã¿ï¼‰
                subject = "çµŒç³¸ï¼ˆã‚¿ãƒ†ã‚¤ãƒˆï¼‰";
                product = "ç´ æ";
            }

            // 1. Steering & Speed (Shape)
            let shapeText = "";
            const flipCount = params.steeringHesitation;
            if (sScore > 0.6) {
                shapeText = `é »ç¹ãªåˆ‡ã‚Šè¿”ã—ï¼ˆFlip: ${flipCount}å›ï¼‰ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸã€‚ãã®å¿ƒã®æºã‚ŒãŒã€${subject}ã«æ¿€ã—ã„æ³¢æ‰“ã¡ã‚’ä¸ãˆã€è¤‡é›‘ã«æ­ªã‚“ã å½¢çŠ¶ã‚’ç”Ÿã¿å‡ºã—ã¦ã„ã¾ã™ã€‚`;
            } else if (sScore > 0.25) {
                shapeText = `æ™‚æŠ˜è¦‹ã›ãŸãƒãƒ³ãƒ‰ãƒ«ã®æºã‚‰ãï¼ˆFlip: ${flipCount}å›ï¼‰ãŒã€${subject}ã«æœ‰æ©Ÿçš„ã§æŸ”ã‚‰ã‹ãªã‚¦ã‚§ãƒ¼ãƒ–ã‚’æãå‡ºã—ã¾ã—ãŸã€‚`;
            } else {
                shapeText = `è¿·ã„ã®ãªã„ãƒãƒ³ãƒ‰ãƒ«æ“ä½œï¼ˆFlip: ${flipCount}å›ï¼‰ã§ã€ã‚¹ãƒ ãƒ¼ã‚ºã«èµ°ã‚ŠæŠœã‘ã¾ã—ãŸã€‚ãã®ãŸã‚ã€${subject}ã¯ç¾ã—ãçœŸã£ç›´ãã«ä¼¸ã³ã€å‡›ã¨ã—ãŸè¡¨æƒ…ã‚’æŒã£ã¦ã„ã¾ã™ã€‚`;
            }

            // 2. Risk (Texture)
            let textureText = "";
            const collisionCount = Math.floor(params.riskTolerance);
            if (rScore > 0.5) {
                textureText = `åº¦é‡ãªã‚‹è¡çªï¼ˆCollision: ${collisionCount}å›ï¼‰ã‚’æã‚Œã¬èµ°ã‚ŠãŒã€å…¨ä½“ã«ãƒã‚¤ã‚ºã¨ã‚°ãƒªãƒƒãƒï¼ˆå‚·è·¡ï¼‰ã‚’åˆ»ã¿è¾¼ã¿ã¾ã—ãŸã€‚`;
            } else if (rScore > 0.1) {
                textureText = `æ”»ã‚ã®èµ°ã‚Šã«ã‚ˆã‚‹æ¥è§¦ï¼ˆCollision: ${collisionCount}å›ï¼‰ãŒã€é©åº¦ãªè’ã€…ã—ã•ã‚’è³ªæ„Ÿã«åŠ ãˆã¦ã„ã¾ã™ã€‚`;
            } else {
                textureText = `è¡çªã‚’é¿ã‘ãŸå®‰å…¨é‹è»¢ã«ã‚ˆã‚Šã€å‚·ã®ãªã„æ»‘ã‚‰ã‹ãªè³ªæ„Ÿã«ä»•ä¸ŠãŒã£ã¦ã„ã¾ã™ã€‚`;
            }

            // 3. Greed & Color (Density & Color)
            let densityText = "";
            let colorText = "";

            // è‰²ã®åç§°å¤‰æ› (ç°¡æ˜“)
            const colorMap = {
                'RED': 'èµ¤', 'BLUE': 'é’', 'GREEN': 'ç·‘',
                'ORANGE': 'ã‚ªãƒ¬ãƒ³ã‚¸', 'PURPLE': 'ç´«', 'MONOCHROME': 'ç„¡å½©è‰²'
            };
            const colName = colorMap[mainColor] || mainColor;

            if (gTotal >= 8) {
                densityText = `å¤šãã®æ¬²æœ›ï¼ˆItems: ${gTotal}å€‹ï¼‰ã‚’æ±‚ã‚ãŸçµæœã€ç›®ãŒè©°ã¾ã£ãŸé‡åšã§é«˜å¯†åº¦ãªä»•ä¸ŠãŒã‚Šã«ãªã‚Šã¾ã—ãŸã€‚`;
                colorText = `ç‰¹ã«ã€Œ${colName}ã€ã¸ã®åŸ·ç€ãŒå¼·ãã€ãã®è‰²ãŒå…¨ä½“ã‚’æ”¯é…ã—ã¦ã„ã¾ã™ã€‚`;
            } else if (gTotal >= 4) {
                densityText = `é©åº¦ãªåé›†æ¬²ï¼ˆItems: ${gTotal}å€‹ï¼‰ã«ã‚ˆã‚Šã€ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸå¯†åº¦ã®${product}ã«ãªã£ã¦ã„ã¾ã™ã€‚`;
                colorText = `ã€Œ${colName}ã€ã‚’åŸºèª¿ã¨ã—ãŸã€è½ã¡ç€ãã®ã‚ã‚‹é…è‰²ã§ã™ã€‚`;
            } else {
                densityText = `åé›†ã‚’æŠ‘ãˆãŸï¼ˆItems: ${gTotal}å€‹ï¼‰ã“ã¨ã§ã€éå¸¸ã«è»½ã‚„ã‹ã§é€ã‘æ„Ÿã®ã‚ã‚‹ä»•ä¸ŠãŒã‚Šã«ãªã‚Šã¾ã—ãŸã€‚`;
                colorText = `ã€Œ${colName}ã€ãŒé™ã‹ã«ä¸»å¼µã™ã‚‹ã€ãƒŸãƒ‹ãƒãƒ«ãªæ§‹æˆã§ã™ã€‚`;
            }

            // HTMLæ§‹ç¯‰
            const html = `
                <div class="report-section">
                    <div class="report-title">DRIVING RESULT</div>
                    <div class="report-text">
                        ${shapeText}
                        ${textureText}
                        ${densityText}
                        ${colorText}
                    </div>
                </div>

                <div class="report-section" style="border-bottom: none;">
                    <div class="report-title">MATERIAL DIAGNOSIS</div>
                    <div class="report-text">
                        ç¹Šç¶­ã§è¨€ã†ãªã‚‰ã€ã“ã®ãƒãƒ†ãƒªã‚¢ãƒ«ã§ã—ã‚‡ã†ã€‚
                    </div>
                    
                    <div class="diagnosis-name-en">
                        ${resultData.nameEn}
                    </div>
                    <div class="diagnosis-name-jp">
                        ${resultData.nameJp}
                    </div>
                    <div class="diagnosis-desc">
                        ${resultData.desc}
                    </div>
                    
                    <div style="margin-top: 25px; font-size: 10px; color: #ccc; font-family: 'DIN 2014';">
                        S:${(params.baseMetrics.steerScore).toFixed(2)} / R:${(params.baseMetrics.crashScore).toFixed(2)} / G:${gTotal}
                    </div>
                </div>
            `;

            reportDiv.innerHTML = html;
            reportDiv.style.display = 'block';
        }

        // --- ãƒ†ã‚­ã‚¹ã‚¿ã‚¤ãƒ«ç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³ ---
        const textileEngine = {
            palettes: {
                monochrome: { bg: '#ffffff', warp: '#1a1a1a', weft: '#1a1a1a' },
                red: { bg: '#ffffff', warp: '#e60012', weft: '#e60012' },
                blue: { bg: '#ffffff', warp: '#0066cc', weft: '#0066cc' },
                green: { bg: '#ffffff', warp: '#009944', weft: '#009944' },
                orange: { bg: '#ffffff', warp: '#ff6600', weft: '#ff6600' },
                purple: { bg: '#ffffff', warp: '#6b0099', weft: '#6b0099' }
            },
            warpSeed: 1,
            weftSeed: 1,
            warpRnd: function () { this.warpSeed = (this.warpSeed * 9301 + 49297) % 233280; return this.warpSeed / 233280; },
            weftRnd: function () { this.weftSeed = (this.weftSeed * 7901 + 31337) % 233280; return this.weftSeed / 233280; },
            hexToRgba: function (hex, alpha) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }
        };

        function generateTextile(warpParams, weftParams = null) {
            const tCanvas = document.getElementById('textileCanvas');
            const tCtx = tCanvas.getContext('2d');
            const W = tCanvas.width;
            const H = tCanvas.height;

            textileEngine.warpSeed = Date.now();
            textileEngine.weftSeed = Date.now() + 99999;

            // çµŒç³¸ã®ãƒ‘ãƒ¬ãƒƒãƒˆ
            const warpPal = textileEngine.palettes[warpParams.paletteId] || textileEngine.palettes.monochrome;
            // ç·¯ç³¸ã®ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆæŒ‡å®šãŒã‚ã‚Œã°ï¼‰
            const weftPal = weftParams ? (textileEngine.palettes[weftParams.paletteId] || textileEngine.palettes.monochrome) : warpPal;

            tCtx.fillStyle = warpPal.bg;
            tCtx.fillRect(0, 0, W, H);

            const warpSpacing = 20 + (1 - warpParams.density) * 70;
            const warpAmp = warpParams.warpAmp * 60;
            const warpFreq = 0.002 + warpParams.warpFreq * 0.02;
            const lineW = 1.0 + 0.3 * 25;
            const warpNoise = warpParams.noise;
            const warpStyle = warpParams.style;
            const alpha = 1.0;

            tCtx.lineCap = 'round';
            tCtx.lineJoin = 'round';

            // WARPï¼ˆçµŒç³¸ï¼‰æç”»
            tCtx.strokeStyle = textileEngine.hexToRgba(warpPal.warp, alpha);
            tCtx.lineWidth = lineW;
            for (let x = warpSpacing / 2; x < W; x += warpSpacing) {
                if (textileEngine.warpRnd() < warpNoise * 0.15) continue;
                tCtx.beginPath();
                const phase = textileEngine.warpRnd() * Math.PI * 2;
                const localAmp = warpAmp * (0.6 + textileEngine.warpRnd() * 0.4);
                const localFreq = warpFreq * (0.7 + textileEngine.warpRnd() * 0.6);
                for (let y = 0; y <= H; y += 4) {
                    let wave = Math.sin(y * localFreq + phase) * localAmp;
                    if (warpNoise > 0) wave += (textileEngine.warpRnd() - 0.5) * warpNoise * 30;
                    if (warpStyle === 'organic') wave += Math.sin(y * 0.005 + x * 0.002) * 40;
                    else if (warpStyle === 'glitch') if (textileEngine.warpRnd() < 0.02) wave += (textileEngine.warpRnd() - 0.5) * 200;
                    const px = x + wave;
                    y === 0 ? tCtx.moveTo(px, y) : tCtx.lineTo(px, y);
                }
                tCtx.stroke();
            }

            // WEFTï¼ˆç·¯ç³¸ï¼‰æç”» - weftParamsãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã®ã¿
            if (weftParams) {
                const weftSpacing = 20 + (1 - weftParams.density) * 70;
                const weftAmp = weftParams.warpAmp * 60;
                const weftFreq = 0.002 + weftParams.warpFreq * 0.02;
                const weftNoise = weftParams.noise;
                const weftStyle = weftParams.style;

                tCtx.strokeStyle = textileEngine.hexToRgba(weftPal.weft, alpha);
                tCtx.lineWidth = lineW * 0.85;
                for (let y = weftSpacing / 2; y < H; y += weftSpacing) {
                    if (textileEngine.weftRnd() < weftNoise * 0.2) continue;
                    tCtx.beginPath();
                    const phase = textileEngine.weftRnd() * Math.PI * 2;
                    const localAmp = weftAmp * (0.6 + textileEngine.weftRnd() * 0.4);
                    const localFreq = weftFreq * (0.7 + textileEngine.weftRnd() * 0.6);
                    for (let x = 0; x <= W; x += 4) {
                        let wave = Math.sin(x * localFreq + phase) * localAmp;
                        if (weftNoise > 0) wave += (textileEngine.weftRnd() - 0.5) * weftNoise * 30;
                        if (weftStyle === 'organic') wave += Math.cos(x * 0.005 + y * 0.002) * 30;
                        else if (weftStyle === 'glitch') if (textileEngine.weftRnd() < 0.02) wave += (textileEngine.weftRnd() - 0.5) * 160;
                        const py = y + wave;
                        x === 0 ? tCtx.moveTo(x, py) : tCtx.lineTo(x, py);
                    }
                    tCtx.stroke();
                }
            }

            const g = tCtx.createRadialGradient(W / 2, H / 2, H * 0.4, W / 2, H / 2, H * 0.9);
            g.addColorStop(0, 'rgba(255,255,255,0)');
            g.addColorStop(1, 'rgba(255,255,255,0.7)');
            tCtx.fillStyle = g;
            tCtx.fillRect(0, 0, W, H);

            return tCanvas.toDataURL('image/jpeg', 0.9);
        }

        // --- å…±æœ‰æ©Ÿèƒ½ ---
        // --- å…±æœ‰æ©Ÿèƒ½ (æ‹›å¾…ãƒ»ã‚³ãƒ©ãƒœå®Œäº†) ---

        // --- URLåœ§ç¸®ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
        function compressWarpData(data) {
            // ã‚­ãƒ¼çŸ­ç¸®ã¨æ•°å€¤ä¸¸ã‚
            return {
                c: data.paletteId,
                a: parseFloat(data.warpAmp.toFixed(3)),
                f: parseFloat(data.warpFreq.toFixed(3)),
                d: parseFloat(data.density.toFixed(3)),
                n: parseFloat(data.noise.toFixed(3)),
                s: data.style
            };
        }

        function decompressWarpData(data) {
            // çŸ­ç¸®ã‚­ãƒ¼ãŒã‚ã‚‹å ´åˆã¯å¾©å…ƒã€ãªã‘ã‚Œã°ãã®ã¾ã¾ï¼ˆäº’æ›æ€§ï¼‰
            if (data.c !== undefined) {
                return {
                    paletteId: data.c,
                    warpAmp: data.a,
                    warpFreq: data.f,
                    density: data.d,
                    noise: data.n,
                    style: data.s
                };
            }
            return data;
        }

        // 1. æ‹›å¾…ãƒªãƒ³ã‚¯ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼ (Warpãƒ¢ãƒ¼ãƒ‰ç”¨)
        function getInviteUrl() {
            if (!window.currentWarpData) return window.location.href; // ãƒ‡ãƒ¼ã‚¿ãªã‘ã‚Œã°ãƒˆãƒƒãƒ—ã¸

            // åœ§ç¸®ã—ã¦JSONåŒ–
            const compressed = compressWarpData(window.currentWarpData);
            const jsonStr = JSON.stringify(compressed);
            const base64 = btoa(jsonStr);

            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}?warp=${base64}`;
        }

        // 2. Twitter æ‹›å¾…ã‚·ã‚§ã‚¢ (çµŒç³¸ãƒ¢ãƒ¼ãƒ‰å®Œäº†æ™‚)
        function shareInviteToTwitter() {
            const url = getInviteUrl();
            const text = `I wove the warp. Someone please weave the weft to complete the fabric.\n\nç§ãŒã€ŒçµŒç³¸ã€ã‚’ç¹”ã‚Šã¾ã—ãŸã€‚èª°ã‹ã€Œç·¯ç³¸ã€ã‚’ç¹”ã£ã¦å¸ƒã‚’å®Œæˆã•ã›ã¦ãã ã•ã„ã€‚\n#IndustrialRun\n`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
        }

        // 3. LINE æ‹›å¾…ã‚·ã‚§ã‚¢ (çµŒç³¸ãƒ¢ãƒ¼ãƒ‰å®Œäº†æ™‚)
        function shareInviteToLINE() {
            const url = getInviteUrl();
            const text = `I wove the warp. Join to weave the weft.\nç§ãŒã€ŒçµŒç³¸ã€ã‚’ç¹”ã‚Šã¾ã—ãŸã€‚ãƒªãƒ³ã‚¯ã‚’é–‹ã„ã¦ã€Œç·¯ç³¸ã€ã‚’ç¹”ã£ã¦ãã ã•ã„ã€‚`;
            window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`, '_blank');
        }

        // 3-2. LINE å ±å‘Š (ç·¯ç³¸ãƒ¢ãƒ¼ãƒ‰å®Œäº†æ™‚)
        function reportToHostLINE() {
            const text = `The Weft is woven. The fabric is complete.\n\nç·¯ç³¸ï¼ˆãƒ¨ã‚³ã‚¤ãƒˆï¼‰ã‚’ç¹”ã‚Šã¾ã—ãŸã€‚å®Œæˆã—ãŸå¸ƒã®ç”»åƒã‚’é€ã‚Šã¾ã™ã€‚`;
            // ç”»åƒã¯é€ã‚Œãªã„ã®ã§ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚·ã‚§ã‚¢ç”»é¢ã‚’é–‹ã
            window.open(`https://social-plugins.line.me/lineit/share?text=${encodeURIComponent(text)}`, '_blank');
        }

        // 3-3. VIP å‡ºå¸­ã‚·ã‚§ã‚¢
        function shareAttendanceToTwitter() {
            const id = document.getElementById('material-id').innerText;
            const text = `I am attending the exhibition with my exclusive textile invite.\nTicket ID: ${id}\n\nç¹Šç¶­ç”£æ¥­ç ”ç©¶å ±å‘Šä¼šã«å‚åŠ ã—ã¾ã™ã€‚\n#IndustrialRun #20260228`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.href)}`, '_blank');
        }

        // 4. é€šå¸¸ã‚·ã‚§ã‚¢ (å®Œäº†ç”»åƒ or VIP)
        function shareToInstagram() {
            const imageUrl = document.getElementById('material-image').src;
            const a = document.createElement('a');
            a.href = imageUrl;
            a.download = 'industrial_run_textile.jpg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function shareToTwitter() {
            // å˜ç´”ãªçµæœã‚·ã‚§ã‚¢
            const text = `Industrial Run Material Generated: ${document.getElementById('material-id').innerText}\n#IndustrialRun`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.href)}`, '_blank');
        }

        // 5. æ‰‹å‹•ã‚³ãƒ”ãƒ¼ (Fallback)
        function copyInviteLink() {
            const url = getInviteUrl();
            const input = document.getElementById('invite-link-input');
            input.value = url;
            input.select();
            input.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(url).then(() => {
                alert('Invite Link Copied!');
            }).catch(() => {
                alert('Copy failed. Please select and copy manually.');
            });
        }

        function goToReservation() {
            window.open('https://mautextileindustrylab.peatix.com/', '_blank');
        }

        function addToCalendar() {
            const baseUrl = "https://www.google.com/calendar/render?action=TEMPLATE";
            const title = "ç¬¬ä¸€å› ç¹Šç¶­ç”£æ¥­ç ”ç©¶å ±å‘Šä¼š -è»Šã¨ç¹Šç¶­-";
            const start = "20260228T170000";
            const end = "20260228T183000";
            const location = "ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒšãƒ¼ã‚¹ MATERIALï¼ˆé«˜å††å¯ºï¼‰ æ±äº¬éƒ½æ‰ä¸¦åŒºé«˜å††å¯ºå—4-4-11";
            const details = "æ­¦è”µé‡ç¾è¡“å¤§å­¦ ç¹Šç¶­ç”£æ¥­ç ”ç©¶ä¼šã«ã‚ˆã‚‹åˆã®ç ”ç©¶æˆæœç™ºè¡¨ã®å ´ã§ã™ã€‚ãƒˆãƒ¨ã‚¿ç´¡ç¹”ã€ŒRE:TERRACEã€ã‹ã‚‰ã®ç´ ææä¾›ã‚’å—ã‘ã€è‡ªå‹•è»Šç”¨ç¹Šç¶­ç´ æã‚’ç”¨ã„ãŸãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ã‚·ãƒ§ãƒ¼ã€å±•ç¤ºã‚’è¡Œã„ã¾ã™ã€‚\n\nè©³ç´°ï¼šhttps://mautextileindustrylab.peatix.com/";

            const url = `${baseUrl}&text=${encodeURIComponent(title)}&dates=${start}/${end}&location=${encodeURIComponent(location)}&details=${encodeURIComponent(details)}`;
            window.open(url, '_blank');
        }

        // å¤ã„é–¢æ•°ï¼ˆgenerateInviteLinkï¼‰ã¯å»ƒæ­¢

        // Initialize Game
        init();

        // 6. ãƒªã‚»ãƒƒãƒˆ (RETRY)
        function resetUserData() {
            if (confirm("ç¾åœ¨ã®çµæœãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã€æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ\n(This will delete your woven textile data.)")) {
                const storageKey = getStorageKey();
                localStorage.removeItem(storageKey);
                window.location.reload();
            }
        }

        // 7. çµæœç”»é¢å¾©å…ƒ (Restore)
        function restoreResultScreen() {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¼·åˆ¶çµ‚äº†
            const loader = document.getElementById('loading-overlay');
            if (loader) {
                loader.style.opacity = '0';
                loader.style.display = 'none';
            }

            // ã‚²ãƒ¼ãƒ ç”»é¢ãªã©ã‚’éš ã™
            gameState = 'ended'; // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã¸ã®å½±éŸ¿ã‚’æ­¢ã‚ã‚‹
            const startScreen = document.getElementById('start-screen');
            if (startScreen) startScreen.style.display = 'none';

            const mobileControls = document.getElementById('mobile-controls');
            if (mobileControls) mobileControls.style.display = 'none'; // æ“ä½œUIã‚‚éš ã™

            const uiLayer = document.getElementById('ui-layer');
            if (uiLayer) uiLayer.style.display = 'none'; // UIãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’éš ã™ (SYSTEM BOOTINGå«ã‚€)

            const speedMeter = document.getElementById('speedometer');
            if (speedMeter) speedMeter.style.display = 'none'; // ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚‚éš ã™

            document.getElementById('gameCanvas').style.display = 'none';
            const scanlines = document.getElementById('scanlines');
            if (scanlines) scanlines.style.display = 'block';

            // åˆæœŸã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ (SYSTEM BOOTING...) ã‚’æ¶ˆã™
            const caption = document.getElementById('caption');
            if (caption) caption.style.display = 'none';

            const resScreen = document.getElementById('result-screen');
            if (resScreen) {
                resScreen.style.display = 'flex';
                resScreen.style.opacity = '1';
            }

            // ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»
            setTimeout(() => {
                try {
                    const tCanvas = document.getElementById('textileCanvas');
                    let dataUrl = null;
                    if (tCanvas && window.genParams) {
                        if (window.vipData) {
                            // VIPå¾©å…ƒ: ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯å†æ§‹ç¯‰
                            if (!window.genParams) {
                                console.error("Missing genParams for VIP restoration");
                                throw new Error("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã§ã™ (genParams missing)");
                            }

                            // vipColorsãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†ã€ãªã‘ã‚Œã°genParamsã‹ã‚‰æ¨æ¸¬ã€ã‚ã‚‹ã„ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                            const mainColor = (window.vipColors && window.vipColors.main) ||
                                (window.vipData && window.vipData.color) ||
                                (window.genParams && window.genParams.paletteId) ||
                                'MONOCHROME';

                            const subColor = (window.vipColors && window.vipColors.sub) ||
                                (window.vipData && window.vipData.subColor) ||
                                mainColor;

                            // çµŒç³¸ (Main)
                            const warpP = JSON.parse(JSON.stringify(window.genParams));
                            warpP.paletteId = mainColor;

                            // ç·¯ç³¸ (Sub)
                            const weftP = JSON.parse(JSON.stringify(window.genParams));
                            weftP.paletteId = subColor;

                            dataUrl = generateTextile(warpP, weftP);
                        } else if (window.isWeftMode && window.warpDataFromUrl) {
                            // ã‚³ãƒ©ãƒœå¾©å…ƒ: URLç”±æ¥ã®çµŒç³¸ + è‡ªåˆ†ã®ç·¯ç³¸
                            dataUrl = generateTextile(window.warpDataFromUrl, window.genParams);
                        } else {
                            // é€šå¸¸: çµŒç³¸ã®ã¿
                            dataUrl = generateTextile(window.genParams);
                        }
                    }

                    // ç”»åƒè¡¨ç¤º
                    const imgEl = document.getElementById('material-image');
                    if (imgEl && dataUrl) {
                        imgEl.src = dataUrl;
                        imgEl.style.display = 'block';
                    }

                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ†ã‚­ã‚¹ãƒˆéè¡¨ç¤º
                    const loadTxt = document.getElementById('loading-text');
                    if (loadTxt) loadTxt.style.display = 'none';

                    // ãƒãƒ†ãƒªã‚¢ãƒ«IDè¡¨ç¤º
                    const idEl = document.getElementById('material-id');
                    if (idEl) idEl.style.display = 'block';

                    // çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ (New) - diagnosisParamsãŒã‚ã‚‹å ´åˆã®ã¿
                    if (window.diagnosisParams && window.diagnosisResults) {
                        try {
                            generateAnalysisReport(window.diagnosisParams, window.diagnosisResults);
                            const repDiv = document.getElementById('analysis-report');
                            if (repDiv) repDiv.style.display = 'block';
                        } catch (e) {
                            console.error("Analysis Report Generation Failed:", e);
                            // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå¤±æ•—æ™‚ã¯éè¡¨ç¤ºã®ã¾ã¾ã«ã™ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼ã§å…¨ä½“ã‚’æ­¢ã‚ãªã„ï¼‰
                        }
                    }

                    // ãƒ†ã‚­ã‚¹ãƒˆåæ˜ 
                    const r = window.diagnosisResults;
                    if (r) {
                        const elNameEn = document.getElementById('m-name-en');
                        const elNameJp = document.getElementById('m-name-jp');
                        const elDesc = document.getElementById('m-desc');
                        const elId = document.getElementById('m-id');

                        if (elNameEn) elNameEn.innerText = r.nameEn;
                        if (elNameJp) elNameJp.innerText = r.nameJp;
                        if (elDesc) elDesc.innerText = r.desc;
                        if (elId) elId.innerText = r.id;

                        // ãƒãƒ£ãƒ¼ãƒˆã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã—ãªã„ã¨åæ˜ ã•ã‚Œãªã„ã®ã§ç°¡æ˜“çš„ã«å¹…ã‚»ãƒƒãƒˆ
                        setTimeout(() => {
                            const barR = document.querySelector('.bar-fill.r');
                            const barV = document.querySelector('.bar-fill.v');
                            const barG = document.querySelector('.bar-fill.g');

                            if (barR) barR.style.width = `${r.chart.risk}%`;
                            if (barV) barV.style.width = `${r.chart.variance}%`;
                            if (barG) barG.style.width = `${r.chart.greed}%`;
                        }, 500);
                    }

                    // ã‚³ãƒ©ãƒœã‚¨ãƒªã‚¢è¡¨ç¤ºåˆ¶å¾¡
                    const collabSection = document.getElementById('collab-section');
                    if (collabSection) collabSection.style.display = 'block';

                    // UIè¡¨ç¤ºåˆ†å²
                    if (window.vipData) { // isVipå¤‰æ•°ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã ãŒå¿µã®ãŸã‚window.vipDataç¢ºèª
                        const vipRes = document.getElementById('vip-mode-result');
                        if (vipRes) vipRes.style.display = 'block';

                        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã®æ›´æ–° (ã‚»ãƒ¬ã‚¯ã‚¿ä¿®æ­£)
                        const titleEl = document.querySelector('#result-screen .header');
                        if (titleEl) titleEl.innerHTML = `OFFICIAL TICKET`;

                        // ãƒã‚±ãƒƒãƒˆãƒ›ãƒ«ãƒ€ãƒ¼æƒ…å ±ã®è¿½åŠ 
                        const holderArea = document.getElementById('vip-ticket-holder');
                        const nameEl = document.getElementById('vip-holder-name');
                        if (holderArea && nameEl) {
                            nameEl.innerText = window.vipData.name;
                            holderArea.style.display = 'block';
                        }
                    } else if (window.isWeftMode) {
                        const weftRes = document.getElementById('weft-mode-result');
                        if (weftRes) weftRes.style.display = 'block';

                        const resBtn = document.getElementById('reserve-btn');
                        if (resBtn) resBtn.style.display = 'block';
                        const calBtn = document.getElementById('calendar-btn');
                        if (calBtn) calBtn.style.display = 'block';
                    } else {
                        const warpActions = document.getElementById('warp-mode-actions');
                        if (warpActions) warpActions.style.display = 'block';

                        const resBtn = document.getElementById('reserve-btn');
                        const calBtn = document.getElementById('calendar-btn');
                        const shareDiv = document.querySelector('.share-buttons-container');
                        if (resBtn) resBtn.style.display = 'block';
                        if (calBtn) calBtn.style.display = 'block';
                        if (shareDiv) shareDiv.style.display = 'flex';
                    }

                } catch (e) {
                    console.error('Error during result restoration:', e);
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚å¼·åˆ¶çš„ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¶ˆã™
                    const loadTxt = document.getElementById('loading-text');
                    if (loadTxt) {
                        loadTxt.innerText = "ERROR LOADING DATA";
                        loadTxt.style.color = "red";
                    }
                } finally {
                    const loadTxt = document.getElementById('loading-text');
                    if (loadTxt && loadTxt.innerText !== "ERROR LOADING DATA") {
                        loadTxt.style.display = 'none';
                    }
                }
            }, 500);
        }
    </script>
</body>

</html>